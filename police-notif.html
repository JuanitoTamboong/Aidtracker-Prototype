<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Police Station - AidTracker Notifications</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Leaflet Fullscreen -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.min.js"></script>

  <style>
    :root {
      --primary-blue: #001f3f;
      --dark-blue: #003366;
      --accent-gold: #ffd700;
      --light-gold: #fff8dc;
      --danger-red: #e74c3c;
      --warning-orange: #f39c12;
      --success-green: #2ecc71;
      --police-blue: #2c3e50;
      --police-dark: #1a252f;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --header-height: 70px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
      background-attachment: fixed;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* === Glass Morphism Effect === */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
    }

    /* === Header === */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      z-index: 1000;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 31, 63, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--accent-gold);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      font-size: 20px;
      flex-shrink: 0;
    }

    .header-titles {
      min-width: 0;
      flex: 1;
    }

    .main-title {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .main-title span {
      color: var(--accent-gold);
    }

    .subtitle {
      font-size: 11px;
      color: var(--light-gold);
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--success-green);
      margin-left: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .notification-btn {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--accent-gold);
      font-size: 18px;
      flex-shrink: 0;
    }

    .notification-btn:hover {
      background: rgba(255, 215, 0, 0.1);
    }

    .notif-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background-color: var(--danger-red);
      border-radius: 50%;
      display: none;
    }

    /* === Main Content === */
    .main-content {
      padding: calc(var(--header-height) + 16px) 16px 16px;
      max-width: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* === Notification Cards === */
    .notification-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      transition: all 0.3s ease;
      position: relative;
    }

    .notification-card:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .incident-type {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 10px;
      background: rgba(243, 156, 18, 0.2);
      color: var(--accent-gold);
      border: 1px solid rgba(243, 156, 18, 0.5);
    }

    .reporter-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .reporter-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-gold), #ffed4e);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      font-size: 16px;
      font-weight: bold;
    }

    .reporter-details {
      flex: 1;
    }

    .reporter-name {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 2px;
    }

    .reporter-time {
      font-size: 12px;
      color: var(--accent-gold);
      opacity: 0.8;
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 8px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 11px;
      color: var(--accent-gold);
      opacity: 0.8;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      min-width: 100px;
      text-align: center;
    }

    .status-pending {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
    }

    .status-investigating {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
    }

    .status-resolved {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .responders-btn {
      background: var(--accent-gold);
      color: var(--primary-blue);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
      min-width: 140px;
    }

    .responders-btn:hover {
      background: #ffed4e;
      transform: translateY(-2px);
    }

    .view-btn {
      background: transparent;
      border: 1px solid var(--accent-gold);
      color: var(--accent-gold);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
      min-width: 140px;
    }

    .view-btn:hover {
      background: rgba(255, 215, 0, 0.1);
      transform: translateY(-2px);
    }

    .resolve-btn {
      background: var(--success-green);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
      min-width: 140px;
    }

    .resolve-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .quick-route-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .quick-route-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    /* Police specific styling */
    .police-unit {
      background: rgba(44, 62, 80, 0.2);
      color: #2c3e50;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      border: 1px solid rgba(44, 62, 80, 0.3);
    }

    /* Loading States */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      flex-direction: column;
      gap: 16px;
      color: var(--light-gold);
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent-gold);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      padding: 60px 20px;
      text-align: center;
      color: var(--light-gold);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
      color: var(--accent-gold);
    }

    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--accent-gold);
    }

    .empty-state p {
      font-size: 14px;
      opacity: 0.7;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
      width: 90%;
      max-width: 500px;
      border-radius: 16px;
      border: 2px solid var(--accent-gold);
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      color: var(--accent-gold);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .modal-section {
      margin-bottom: 25px;
    }

    .modal-section-title {
      color: var(--accent-gold);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-input, .modal-select, .modal-textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255, 215, 0, 0.5);
      color: white;
      font-size: 16px;
      outline: none;
      font-family: inherit;
      margin-bottom: 10px;
    }

    .modal-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .modal-btn-primary {
      flex: 1;
      background: var(--accent-gold);
      color: var(--primary-blue);
      border: none;
      padding: 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .modal-btn-primary:hover {
      background: #ffed4e;
    }

    .modal-btn-secondary {
      flex: 1;
      background: transparent;
      border: 2px solid var(--accent-gold);
      color: var(--accent-gold);
      padding: 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .modal-btn-secondary:hover {
      background: rgba(255, 215, 0, 0.1);
    }

    /* Map containers */
    .route-map-container {
      height: 300px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid rgba(255, 215, 0, 0.3);
      margin-bottom: 20px;
      position: relative;
    }

    #routeMap, #fullscreenMap {
      width: 100%;
      height: 100%;
    }

    /* Remove Leaflet default controls */
    .leaflet-control-container .leaflet-control-zoom {
      display: none !important;
    }

    .leaflet-control-attribution {
      display: none !important;
    }

    /* Custom map controls */
    .custom-map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .custom-map-control-btn {
      background: rgba(0, 31, 63, 0.9);
      border: 1px solid rgba(255, 215, 0, 0.5);
      color: var(--accent-gold);
      width: 35px;
      height: 35px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .custom-map-control-btn:hover {
      background: rgba(255, 215, 0, 0.2);
      transform: scale(1.1);
      border-color: var(--accent-gold);
    }

    /* Fullscreen map container */
    .fullscreen-map-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 20000;
      background: var(--primary-blue);
      display: none;
    }

    .fullscreen-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 31, 63, 0.9);
      color: var(--accent-gold);
      padding: 15px 20px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--accent-gold);
    }

    .fullscreen-close {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.5);
      color: var(--accent-gold);
      padding: 10px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 12px;
    }

    .fullscreen-close:hover {
      background: rgba(255, 215, 0, 0.2);
    }

    .map-controls {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-control-btn {
      background: rgba(0, 31, 63, 0.9);
      border: 2px solid var(--accent-gold);
      color: var(--accent-gold);
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 180px;
    }

    .map-control-btn:hover {
      background: rgba(255, 215, 0, 0.1);
      transform: translateY(-2px);
    }

    /* Route info */
    .route-info {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }

    .route-info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .route-info-label {
      color: var(--accent-gold);
      font-weight: 600;
      font-size: 14px;
    }

    .route-info-value {
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-header {
        font-size: 18px;
        padding: 12px 15px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .responders-btn,
      .view-btn,
      .resolve-btn {
        width: 100%;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
      
      .route-map-container {
        height: 250px;
      }
      
      .map-controls {
        top: 100px;
        right: 10px;
      }
      
      .map-control-btn {
        min-width: 160px;
        padding: 8px 12px;
        font-size: 14px;
      }
    }

    @media (min-width: 768px) {
      :root {
        --header-height: 80px;
      }

      .main-title {
        font-size: 22px;
      }

      .subtitle {
        font-size: 13px;
      }

      .main-content {
        padding: calc(var(--header-height) + 24px) 24px 24px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .details-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .route-map-container {
        height: 400px;
      }
    }

    /* High Contrast Mode Support */
    @media (prefers-contrast: high) {
      .glass {
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid white;
      }

      .notification-card {
        border: 2px solid var(--accent-gold);
      }
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <!-- Main Header -->
  <header class="main-header glass">
    <div class="header-left">
      <div class="logo-icon">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="header-titles">
        <div class="main-title">Police<span>Station</span>
          <span class="live-badge">
            <i class="fas fa-broadcast-tower"></i> LIVE
          </span>
        </div>
        <div class="subtitle">Emergency Police Response Notifications</div>
      </div>
    </div>

    <div class="header-actions">
      <div class="notification-btn glass" onclick="goBack()" title="Back to Dashboard">
        <i class="fas fa-arrow-left"></i>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div id="status" class="loading">
      <div class="loading-spinner"></div>
      <span>Loading police incidents...</span>
    </div>
    
    <div id="notificationList"></div>
  </main>

  <!-- Fullscreen Map Container -->
  <div id="fullscreenMapContainer" class="fullscreen-map-container">
    <div class="fullscreen-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-shield-alt"></i>
        <span>Police Department Navigation</span>
      </div>
      <button class="fullscreen-close" onclick="closeFullscreenMap()">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
    
    <div id="fullscreenMap"></div>
    
    <div class="map-controls">
      <button class="map-control-btn" onclick="calculateDirectRoute()">
        <i class="fas fa-route"></i> Show Route
      </button>
      <button class="map-control-btn" onclick="locateUserOnMap()">
        <i class="fas fa-crosshairs"></i> My Location
      </button>
      <button class="map-control-btn" onclick="showIncidentDetails()">
        <i class="fas fa-info-circle"></i> Incident Info
      </button>
    </div>
  </div>

  <!-- Responders Modal -->
  <div id="respondersModal" class="modal-overlay">
    <div class="modal-content glass">
      <div class="modal-header">
        <i class="fas fa-shield-alt"></i> Police Response Assignment
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-id-card"></i> Incident Details
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
          <div style="color: var(--accent-gold); font-size: 12px; margin-bottom: 4px;">Incident ID</div>
          <div id="modalIncidentId" style="color: white; font-weight: bold; font-size: 16px;"></div>
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
          <div style="color: var(--accent-gold); font-size: 12px; margin-bottom: 4px;">Reporter</div>
          <div id="modalReporterName" style="color: white; font-size: 16px;"></div>
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-users"></i> Police Unit Assigned
        </div>
        <div class="police-unit">
          <i class="fas fa-shield-alt"></i> POLICE STATION
        </div>
        <div style="color: var(--accent-gold); font-size: 12px; text-align: center; margin-bottom: 10px;">
          This is a police-related incident. Police unit has been automatically assigned.
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-user-shield"></i> Officer Information
        </div>
        <div style="background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
          <label style="display: block; color: var(--accent-gold); font-size: 12px; margin-bottom: 5px; font-weight: 600;">
            Officer Name (max 20 characters)
          </label>
          <input type="text" id="responderName" class="modal-input" placeholder="Enter officer name" maxlength="20" pattern="[A-Za-z\s]+" title="Please enter letters only">
          
          <label style="display: block; color: var(--accent-gold); font-size: 12px; margin-bottom: 5px; font-weight: 600; margin-top: 10px;">
            Contact Number (11 digits)
          </label>
          <input type="text" id="responderContact" class="modal-input" placeholder="Enter contact number" maxlength="11" pattern="[0-9]*" inputmode="numeric" title="Please enter 11 digits only">
        </div>
      </div>
      
      <div class="modal-buttons">
        <button id="confirmRespondersBtn" class="modal-btn-primary">
          <i class="fas fa-check"></i> Assign Police Officer
        </button>
        <button onclick="closeModal('respondersModal')" class="modal-btn-secondary">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Route Modal -->
  <div id="quickRouteModal" class="modal-overlay">
    <div class="modal-content glass">
      <div class="modal-header">
        <i class="fas fa-route"></i> Police Navigation to Incident
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-map-marker-alt"></i> Incident Location
        </div>
        <div id="routeDestination" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; color: white; font-size: 16px; margin-bottom: 15px;">
          Loading location...
        </div>
        
        <div class="route-map-container">
          <div id="routeMap"></div>
          <!-- Custom map controls -->
          <div class="custom-map-controls">
            <button class="custom-map-control-btn" onclick="zoomInRouteMap()" title="Zoom In">
              <i class="fas fa-plus"></i>
            </button>
            <button class="custom-map-control-btn" onclick="zoomOutRouteMap()" title="Zoom Out">
              <i class="fas fa-minus"></i>
            </button>
            <button class="custom-map-control-btn" onclick="centerOnRoute()" title="Center on Incident">
              <i class="fas fa-bullseye"></i>
            </button>
          </div>
        </div>
        
        <div class="route-info">
          <div class="route-info-item">
            <span class="route-info-label">Responding Unit:</span>
            <span id="assignedUnits" class="route-info-value">POLICE</span>
          </div>
          <div class="route-info-item">
            <span class="route-info-label">Route Status:</span>
            <span id="routeStatus" class="route-info-value">Click "Show Route" to calculate</span>
          </div>
          <div class="route-info-item">
            <span class="route-info-label">Distance:</span>
            <span id="routeDistance" class="route-info-value">-- km</span>
          </div>
          <div class="route-info-item">
            <span class="route-info-label">Estimated Time:</span>
            <span id="routeTime" class="route-info-value">-- minutes</span>
          </div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button onclick="showRouteOnMap()" class="modal-btn-primary" style="background: #3498db;">
          <i class="fas fa-route"></i> Show Route
        </button>
        <button onclick="openFullscreenMap()" class="modal-btn-secondary" style="background: #9b59b6;">
          <i class="fas fa-expand"></i> Fullscreen Map
        </button>
        <button onclick="closeModal('quickRouteModal')" class="modal-btn-secondary">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Resolve Modal -->
  <div id="resolveModal" class="modal-overlay">
    <div class="modal-content glass">
      <div class="modal-header">
        <i class="fas fa-check-circle"></i> Resolve Police Incident
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-info-circle"></i> Incident Details
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
          <div style="color: var(--accent-gold); font-size: 12px; margin-bottom: 4px;">Incident ID</div>
          <div id="resolveIncidentId" style="color: white; font-weight: bold; font-size: 16px;"></div>
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-check-square"></i> Resolution Status
        </div>
        <select id="resolutionStatus" class="modal-select">
          <option value="suspect_apprehended">Suspect Apprehended - Case Closed</option>
          <option value="situation_resolved">Situation Resolved - Peace Restored</option>
          <option value="case_filed">Case Filed - Investigation Complete</option>
          <option value="victim_assisted">Victim Assisted - Support Provided</option>
          <option value="area_secured">Area Secured - Public Safety Restored</option>
          <option value="false_alarm">False Alarm - No Police Action Required</option>
          <option value="handed_over">Handed Over - Transferred to Other Agency</option>
          <option value="no_action_needed">No Action Needed - Situation Normal</option>
        </select>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-sticky-note"></i> Police Report <span style="color: white;">(optional)</span>
        </div>
        <textarea id="resolutionNotes" class="modal-textarea" placeholder="Describe police actions taken, evidence collected, suspects involved, and outcome..."></textarea>
      </div>
      
      <div class="modal-buttons">
        <button id="confirmResolveBtn" class="modal-btn-primary" style="background: var(--success-green);">
          <i class="fas fa-check-double"></i> Mark as Resolved
        </button>
        <button onclick="closeModal('resolveModal')" class="modal-btn-secondary">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============ CONFIGURATION ============
    const SUPABASE_URL = 'https://gwvepxupoxyyydnisulb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3dmVweHVwb3h5eXlkbmlzdWxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDE4ODcsImV4cCI6MjA4MDM3Nzg4N30.Ku9SXTAKNMvHilgEpxj5HcVA-0TPt4ziuEq0Irao5Qc';
    const OPENROUTE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImJjYzMxOGQ0MGYwMTQ3YTBhZDJlNWU3ZDkxOGNhNGJiIiwiaCI6Im11cm11cjY0In0=';

    // Admin accounts mapping
    const ADMIN_STATIONS = {
        'policeadmin@gmail.com': 'police',
        'fireadmin@gmail.com': 'fire',
        'medicaladmin@gmail.com': 'ambulance'
    };

    // ============ GLOBAL VARIABLES ============
    let supabaseClient = null;
    let currentReportId = null;
    let currentReportData = null;
    let tableColumns = [];
    let routeMap = null;
    let fullscreenMap = null;
    let routeLine = null;
    let assignedRespondersList = [];
    let userCurrentLocation = null;
    let isLoading = false;
    let currentFilter = { type: 'all', status: 'all' };
    let reportsCache = {
        data: null,
        timestamp: null,
        ttl: 5 * 60 * 1000 // 5 minutes cache TTL
    };

    // Incident Type Configuration (POLICE RELATED)
    const typeConfig = {
      all: {
        name: 'Police Incidents'
      },
      crime_theft: {
        name: 'Crime/Theft'
      },
      assault: {
        name: 'Assault'
      },
      vehicular_accident: {
        name: 'Vehicular Accident'
      },
      robbery: {
        name: 'Robbery'
      },
      disturbance: {
        name: 'Disturbance'
      },
      suspicious: {
        name: 'Suspicious Activity'
      }
    };

    // ============ INITIALIZATION ============
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ðŸ‘® Police Department Notifications Initializing...');

      // Initialize Supabase
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // Check for token in URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (token) {
        // Set the session with the token
        try {
          const { data, error } = await supabaseClient.auth.setSession({
            access_token: token,
            refresh_token: token
          });
          if (error) {
            console.warn('Failed to set session with token:', error);
          } else {
            console.log('âœ… Session set with token');
          }
        } catch (error) {
          console.warn('Error setting session:', error);
        }
      }

      // Get user location
      await getUserLocation();

      // Get table columns
      await getTableColumns();

      // Load initial reports
      loadReports();

      // Setup real-time subscription
      setupRealtimeSubscription();

      // Setup event listeners
      setupEventListeners();

      console.log('âœ… Police Department Notifications ready');
    });

    // ============ HELPER FUNCTIONS ============
    async function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          userCurrentLocation = { lat: 12.4048, lng: 121.9829 };
          resolve(userCurrentLocation);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            userCurrentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            resolve(userCurrentLocation);
          },
          () => {
            userCurrentLocation = { lat: 12.4048, lng: 121.9829 };
            resolve(userCurrentLocation);
          }
        );
      });
    }

    async function goBack() {
        const token = localStorage.getItem('token');
        if (token) {
            window.location.href = "/police?token=" + encodeURIComponent(token);
        } else {
            window.location.href = "/police";
        }
    }
    
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      
      if (modalId === 'quickRouteModal' && currentReportData) {
        setTimeout(() => {
          initRouteMap();
        }, 100);
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      if (modalId === 'respondersModal') {
        document.getElementById('responderName').value = '';
        document.getElementById('responderContact').value = '';
      }
      if (modalId === 'quickRouteModal') {
        if (routeLine && routeMap) {
          routeMap.removeLayer(routeLine);
          routeLine = null;
        }
        if (routeMap) {
          routeMap.remove();
          routeMap = null;
        }
      }
    }

    // ============ MAP FUNCTIONS ============
    function openFullscreenMap() {
      if (!currentReportData) return;
      
      document.getElementById('fullscreenMapContainer').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      setTimeout(() => {
        initFullscreenMap();
      }, 100);
    }

    function closeFullscreenMap() {
      document.getElementById('fullscreenMapContainer').style.display = 'none';
      document.body.style.overflow = 'auto';
      
      if (fullscreenMap) {
        fullscreenMap.remove();
        fullscreenMap = null;
      }
    }

    function initFullscreenMap() {
      if (!currentReportData || !document.getElementById('fullscreenMap')) return;
      
      const centerLat = userCurrentLocation ? userCurrentLocation.lat : currentReportData.latitude;
      const centerLng = userCurrentLocation ? userCurrentLocation.lng : currentReportData.longitude;
      
      // Initialize map with NO default zoom controls
      fullscreenMap = L.map('fullscreenMap', {
        zoomControl: false, // Disable default zoom controls
        attributionControl: false, // Disable attribution
        dragging: true,
        touchZoom: true,
        doubleClickZoom: true,
        scrollWheelZoom: true,
        boxZoom: true,
        keyboard: true,
        tap: true
      }).setView([centerLat, centerLng], 14);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(fullscreenMap);
      
      const incidentIcon = L.divIcon({
        html: '<div style="background-color: #2c3e50; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"><i class="fas fa-shield-alt"></i></div>',
        iconSize: [46, 46],
        iconAnchor: [23, 23]
      });
      
      L.marker([currentReportData.latitude, currentReportData.longitude], { icon: incidentIcon })
        .addTo(fullscreenMap)
        .bindPopup(`
          <div style="color: #001f3f; font-weight: bold; font-size: 16px;">
            <i class="fas fa-shield-alt" style="color: #2c3e50;"></i> POLICE INCIDENT
          </div>
          <div style="margin-top: 8px; font-size: 14px;">
            <strong>Location:</strong> ${currentReportData.latitude.toFixed(6)}, ${currentReportData.longitude.toFixed(6)}<br>
            <strong>Status:</strong> INVESTIGATING<br>
            <strong>Assigned:</strong> POLICE
          </div>
        `)
        .openPopup();
      
      if (userCurrentLocation) {
        const userIcon = L.divIcon({
          html: '<div style="background-color: #3498db; width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-user-shield"></i></div>',
          iconSize: [42, 42],
          iconAnchor: [21, 21]
        });
        
        L.marker([userCurrentLocation.lat, userCurrentLocation.lng], { icon: userIcon })
          .addTo(fullscreenMap)
          .bindPopup(`
            <div style="color: #001f3f; font-weight: bold; font-size: 16px;">
              <i class="fas fa-user-shield" style="color: #3498db;"></i> POLICE LOCATION
            </div>
            <div style="margin-top: 8px; font-size: 14px;">
              <strong>Current police position</strong><br>
              <strong>Coordinates:</strong> ${userCurrentLocation.lat.toFixed(6)}, ${userCurrentLocation.lng.toFixed(6)}
            </div>
          `);
      }
    }

    function initRouteMap() {
      if (!currentReportData || !document.getElementById('routeMap')) return;
      
      const centerLat = userCurrentLocation ? userCurrentLocation.lat : currentReportData.latitude;
      const centerLng = userCurrentLocation ? userCurrentLocation.lng : currentReportData.longitude;
      
      // Initialize map with NO default zoom controls
      routeMap = L.map('routeMap', {
        zoomControl: false, // Disable default zoom controls
        attributionControl: false, // Disable attribution
        dragging: true,
        touchZoom: true,
        doubleClickZoom: true,
        scrollWheelZoom: true,
        boxZoom: true
      }).setView([centerLat, centerLng], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(routeMap);
      
      const destIcon = L.divIcon({
        html: '<div style="background-color: #2c3e50; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-shield-alt"></i></div>',
        iconSize: [38, 38],
        iconAnchor: [19, 19]
      });
      
      L.marker([currentReportData.latitude, currentReportData.longitude], { icon: destIcon })
        .addTo(routeMap)
        .bindPopup(`
          <b>Police Incident Location</b><br>
          Police incident requiring response<br>
          Assigned: POLICE
        `)
        .openPopup();
      
      if (userCurrentLocation) {
        const startIcon = L.divIcon({
          html: '<div style="background-color: #3498db; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"><i class="fas fa-user-shield"></i></div>',
          iconSize: [34, 34],
          iconAnchor: [17, 17]
        });
        
        L.marker([userCurrentLocation.lat, userCurrentLocation.lng], { icon: startIcon })
          .addTo(routeMap)
          .bindPopup('<b>Police Current Location</b><br>Officer position');
      }
    }

    // Custom map control functions
    function zoomInRouteMap() {
      if (routeMap) routeMap.zoomIn();
    }

    function zoomOutRouteMap() {
      if (routeMap) routeMap.zoomOut();
    }

    function centerOnRoute() {
      if (routeMap && currentReportData) {
        routeMap.setView([currentReportData.latitude, currentReportData.longitude], 15);
      }
    }

    // ============ DATA FUNCTIONS ============
    async function getTableColumns() {
      try {
        const { data, error } = await supabaseClient
          .from('reports')
          .select('*')
          .limit(1);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          tableColumns = Object.keys(data[0]);
          return true;
        }
        return false;
      } catch {
        tableColumns = ['id', 'type', 'latitude', 'longitude', 'reporter', 'status', 'created_at', 'assigned_responders', 'assigned_unit', 'contact'];
        return false;
      }
    }

    async function loadReports(forceRefresh = false) {
      const statusEl = document.getElementById('status');
      const container = document.getElementById('notificationList');

      if (isLoading && !forceRefresh) return;
      isLoading = true;

      try {
        await getTableColumns();

        // Check cache first (unless force refresh)
        const now = Date.now();
        let data = null;
        let fromCache = false;

        if (!forceRefresh && reportsCache.data && reportsCache.timestamp &&
            (now - reportsCache.timestamp) < reportsCache.ttl) {
          data = reportsCache.data;
          fromCache = true;
          console.log('Loading reports from cache');
        } else {
          // Fetch fresh data from Supabase - ONLY POLICE-RELATED INCIDENTS
          const selectQuery = 'id, type, latitude, longitude, reporter, status, created_at, assigned_responders, assigned_unit, contact, description';

          const { data: allData, error } = await supabaseClient
            .from('reports')
            .select(selectQuery)
            .order('created_at', { ascending: false });

          if (error) {
            // If error, try without the new columns
            const { data: simpleData, error: simpleError } = await supabaseClient
              .from('reports')
              .select('id, type, latitude, longitude, reporter, status, created_at, description')
              .order('created_at', { ascending: false });

            if (simpleError) throw simpleError;
            data = simpleData;
          } else {
            data = allData;
          }

          // Filter to show ONLY police-related incidents
          data = data.filter(report => {
            const dbType = (report.type || '').toString().toLowerCase().trim();
            return (
              dbType.includes('crime') ||
              dbType.includes('theft') ||
              dbType.includes('robbery') ||
              dbType.includes('assault') ||
              dbType.includes('accident') ||
              dbType.includes('vehicular') ||
              dbType.includes('police') ||
              dbType.includes('disturbance') ||
              dbType.includes('suspicious') ||
              dbType.includes('violence') ||
              dbType.includes('fight') ||
              dbType.includes('burglary') ||
              dbType.includes('vandalism') ||
              dbType.includes('harassment') ||
              dbType.includes('danger') ||
              dbType.includes('threat')
            );
          });

          // Update cache
          reportsCache.data = data;
          reportsCache.timestamp = now;
          console.log('Fetched fresh police reports from Supabase');
        }

        if (!data || data.length === 0) {
          statusEl.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-shield-alt"></i>
              <h3>No Police Incidents</h3>
              <p>Police-related reports will appear here once submitted.</p>
            </div>
          `;
          isLoading = false;
          return;
        }

        statusEl.style.display = 'none';

        // Process and display reports
        container.innerHTML = '';
        data.forEach(report => {
          renderNotificationCard(report);
        });

      } catch (error) {
        console.error('Error loading reports:', error);
        statusEl.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Unable to Load Data</h3>
            <p>Please check your connection and try again</p>
            <button class="resolve-btn" onclick="loadReports(true)" style="margin-top: 16px;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      } finally {
        isLoading = false;
      }
    }

    function renderNotificationCard(report) {
      const container = document.getElementById('notificationList');
      
      // Determine incident type
      const dbType = (report.type || '').toString().toLowerCase().trim();
      let incidentType = 'crime_theft';
      let incidentTypeName = 'CRIME/THEFT';

      if (dbType.includes('assault') || dbType.includes('violence') || dbType.includes('fight')) {
        incidentTypeName = 'ASSAULT';
      } else if (dbType.includes('accident') || dbType.includes('vehicular')) {
        incidentTypeName = 'VEHICULAR ACCIDENT';
      } else if (dbType.includes('robbery') || dbType.includes('burglary')) {
        incidentTypeName = 'ROBBERY';
      } else if (dbType.includes('disturbance')) {
        incidentTypeName = 'DISTURBANCE';
      } else if (dbType.includes('suspicious')) {
        incidentTypeName = 'SUSPICIOUS ACTIVITY';
      }
      
      const reporterName = report.reporter || report.reporter_name || report.name || 'Anonymous';
      const reporterInitials = reporterName.charAt(0).toUpperCase();
      
      const reportDate = new Date(report.created_at || report.timestamp || new Date());
      const timeString = reportDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const dateString = reportDate.toLocaleDateString();
      const fullDateTime = reportDate.toLocaleString();
      
      const locationText = report.latitude && report.longitude 
        ? `${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}`
        : 'Location not specified';
      
      const status = (report.status || 'pending').toLowerCase();
      let statusClass = 'status-pending';
      let statusText = 'Pending';
      
      if (status === 'investigating' || status === 'assigned') {
        statusClass = 'status-investigating';
        statusText = 'Investigating';
      } else if (status === 'resolved') {
        statusClass = 'status-resolved';
        statusText = 'Resolved';
      }
      
      // Get assigned responders
      const assignedResponders = report.assigned_responders || '';
      const assignedUnit = report.assigned_unit || '';
      const contact = report.contact || '';
      
      let displayText = '';
      if (assignedUnit && assignedResponders) {
        displayText = `${assignedUnit} - ${assignedResponders}`;
        if (contact) {
          displayText += ` - ${contact}`;
        }
      } else if (assignedResponders) {
        displayText = assignedResponders;
        if (contact) {
          displayText += ` - ${contact}`;
        }
      }
      
      const hasAssignedResponders = displayText.trim() !== '';
      
      const card = document.createElement('div');
      card.className = 'notification-card glass';
      card.dataset.reportId = report.id;
      card.dataset.assignedResponders = displayText;
      
      let actionButtonsHTML = '';
      if (status === 'pending') {
        actionButtonsHTML = `
          <button class="responders-btn" onclick="openRespondersModal('${report.id}', '${reporterName.replace(/'/g, "\\'")}')">
            <i class="fas fa-user-shield"></i> POLICE RESPOND
          </button>
          <button class="view-btn" onclick="viewOnMap(${report.latitude}, ${report.longitude}, '${report.id}')">
            <i class="fas fa-map-marker-alt"></i> VIEW ON MAP
          </button>
        `;
      } else if (status === 'investigating' || status === 'assigned') {
        actionButtonsHTML = `
          <button class="quick-route-btn" onclick="openQuickRouteModal('${report.id}', ${report.latitude}, ${report.longitude}, '${displayText.replace(/'/g, "\\'")}')">
            <i class="fas fa-route"></i> NAVIGATE TO INCIDENT
          </button>
          <button class="resolve-btn" onclick="openResolveModal('${report.id}')">
            <i class="fas fa-check-circle"></i> RESOLVE
          </button>
        `;
      } else {
        actionButtonsHTML = `
          <button class="view-btn" onclick="viewOnMap(${report.latitude}, ${report.longitude}, '${report.id}')" style="flex: 1;">
            <i class="fas fa-map-marker-alt"></i> VIEW LOCATION
          </button>
        `;
      }
      
      card.innerHTML = `
        <div class="incident-type">
          <i class="fas fa-shield-alt"></i> ${incidentTypeName}
        </div>
        
        <div class="reporter-info">
          <div class="reporter-avatar">
            ${reporterInitials}
          </div>
          <div class="reporter-details">
            <div class="reporter-name">${reporterName}</div>
            <div class="reporter-time">${fullDateTime}</div>
          </div>
        </div>
        
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">Time</span>
            <span class="detail-value">${timeString}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Date</span>
            <span class="detail-value">${dateString}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Location</span>
            <span class="detail-value">${locationText}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Report ID</span>
            <span class="detail-value">${report.id ? '#' + report.id.substring(0, 8) : 'N/A'}</span>
          </div>
        </div>
        
        ${report.description ? `
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 215, 0, 0.05); border-radius: 8px; border-left: 3px solid var(--accent-gold);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
              <i class="fas fa-clipboard" style="color: var(--accent-gold); font-size: 14px;"></i>
              <span style="color: var(--accent-gold); font-size: 12px; font-weight: bold;">DESCRIPTION:</span>
            </div>
            <div style="color: white; font-size: 14px; font-weight: 400; line-height: 1.4;">
              ${report.description}
            </div>
          </div>
        ` : ''}
        
        <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 215, 0, 0.05); border-radius: 8px; border-left: 3px solid var(--accent-gold);">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
            <i class="fas fa-user-shield" style="color: #2c3e50; font-size: 14px;"></i>
            <span style="color: var(--accent-gold); font-size: 12px; font-weight: bold;">ASSIGNED POLICE OFFICER:</span>
          </div>
          <div style="color: white; font-size: 14px; font-weight: 600;">
            ${hasAssignedResponders ? displayText : 'No police officer assigned yet'}
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <span style="color: var(--light-gold); font-size: 12px; margin-right: 8px;">Status:</span>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        
        <div class="action-buttons">
          ${actionButtonsHTML}
        </div>
      `;
      
      container.appendChild(card);
    }

    // ============ NOTIFICATION FUNCTIONS ============
    function openRespondersModal(reportId, reporterName) {
      currentReportId = reportId;
      
      document.getElementById('modalIncidentId').textContent = reportId ? '#' + reportId.substring(0, 12) : 'N/A';
      document.getElementById('modalReporterName').textContent = reporterName;
      
      openModal('respondersModal');
    }

    async function assignResponders() {
      const responderName = document.getElementById('responderName').value.trim();
      const responderContact = document.getElementById('responderContact').value.trim();
      
      if (!responderName) {
        alert('Please enter police officer name.');
        return;
      }
      
      if (responderName.length > 20) {
        alert('Officer name must be 20 characters or less.');
        return;
      }
      
      // Validate that name contains only letters and spaces
      const lettersOnly = /^[A-Za-z\s]+$/;
      if (!lettersOnly.test(responderName)) {
        alert('Officer name can only contain letters (A-Z, a-z) and spaces.');
        return;
      }
      
      if (responderContact && responderContact.length !== 11) {
        alert('Contact number must be exactly 11 digits.');
        return;
      }
      
      // Validate contact number contains only digits
      if (responderContact && !/^\d+$/.test(responderContact)) {
        alert('Contact number can only contain digits (0-9).');
        return;
      }
      
      try {
        // Police is automatically assigned for police incidents
        const assignedUnit = 'POLICE STATION';
        const assignedRespondersText = responderName;
        
        // Prepare update data
        const updateData = {
          status: 'investigating',
          updated_at: new Date().toISOString(),
          assigned_responders: assignedRespondersText,
          assigned_unit: assignedUnit,
          contact: responderContact || ''
        };
        
        // Update the report in Supabase
        const { error } = await supabaseClient
          .from('reports')
          .update(updateData)
          .eq('id', currentReportId);
        
        if (error) throw error;
        
        // Format display text as "POLICE - Name"
        let displayText = `${assignedUnit} - ${responderName}`;
        if (responderContact) {
          displayText += ` - ${responderContact}`;
        }
        
        // Show success message
        alert('âœ… Police officer assigned successfully!');
        
        // Close modal and reset
        closeModal('respondersModal');
        document.getElementById('responderName').value = '';
        document.getElementById('responderContact').value = '';
        
        // Reload reports to show updated data
        loadReports(true);
        
      } catch (error) {
        console.error('Error assigning police officer:', error);
        alert('âŒ Error assigning police officer. Please try again.');
      }
    }

    function openQuickRouteModal(reportId, latitude, longitude, assignedResponders = '') {
      currentReportId = reportId;
      
      // If coordinates aren't provided, we'll get them from the database
      if (!latitude || !longitude) {
        supabaseClient
          .from('reports')
          .select('latitude, longitude')
          .eq('id', reportId)
          .single()
          .then(({ data, error }) => {
            if (data) {
              currentReportData = data;
              document.getElementById('routeDestination').textContent = `Coordinates: ${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
            }
          });
      } else {
        currentReportData = { latitude, longitude };
        document.getElementById('routeDestination').textContent = `Coordinates: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
      }
      
      if (assignedResponders) {
        assignedRespondersList = [assignedResponders];
      } else {
        const card = document.querySelector(`[data-report-id="${reportId}"]`);
        if (card && card.dataset.assignedResponders) {
          assignedRespondersList = [card.dataset.assignedResponders];
        }
      }
      
      document.getElementById('assignedUnits').textContent = 'POLICE';
      document.getElementById('routeStatus').textContent = 'Ready for route calculation';
      
      openModal('quickRouteModal');
    }

    function openResolveModal(reportId) {
      currentReportId = reportId;
      document.getElementById('resolveIncidentId').textContent = reportId ? '#' + reportId.substring(0, 12) : 'N/A';
      openModal('resolveModal');
    }

    async function resolveIncident() {
      const statusSelect = document.getElementById('resolutionStatus');
      const selectedOption = statusSelect.options[statusSelect.selectedIndex];
      const statusValue = selectedOption.value;
      const statusText = selectedOption.text.split(' - ')[0].trim();
      
      const notes = document.getElementById('resolutionNotes').value.trim();
      
      try {
        const updateData = {
          status: 'resolved',
          updated_at: new Date().toISOString()
        };
        
        // Construct resolution description
        let resolutionDescription = '';
        
        if (notes) {
          resolutionDescription = `Resolution status: ${statusText} - Police Report: ${notes}`;
        } else {
          resolutionDescription = `Resolution status: ${statusText}`;
        }
        
        // Update description field based on available columns
        if (tableColumns.includes('description')) {
          updateData.description = resolutionDescription;
        } else if (tableColumns.includes('notes')) {
          updateData.notes = resolutionDescription;
        }
        
        // Set resolution_status if column exists
        if (tableColumns.includes('resolution_status')) {
          updateData.resolution_status = statusValue;
        }
        
        const { error } = await supabaseClient
          .from('reports')
          .update(updateData)
          .eq('id', currentReportId);
        
        if (error) throw error;
        
        // Success - close modal and refresh
        closeModal('resolveModal');
        
        // Reset form
        document.getElementById('resolutionStatus').selectedIndex = 0;
        document.getElementById('resolutionNotes').value = '';
        
        // Show success message
        alert('âœ… Police incident marked as resolved!');
        
        // Reload reports
        setTimeout(() => {
          loadReports(true);
        }, 500);
        
      } catch (error) {
        console.error('Error resolving incident:', error);
        alert('âŒ Error marking police incident as resolved. Please try again.');
      }
    }

    // ============ MAP ROUTING FUNCTIONS ============
    async function calculateDirectRoute() {
      if (!fullscreenMap || !currentReportData) return;
      
      if (fullscreenMap._routeLine) {
        fullscreenMap.removeLayer(fullscreenMap._routeLine);
      }
      
      if (fullscreenMap.routeMarkers) {
        fullscreenMap.routeMarkers.forEach(marker => fullscreenMap.removeLayer(marker));
        fullscreenMap.routeMarkers = [];
      }
      
      const startLocation = userCurrentLocation || { lat: 12.4048, lng: 121.9829 };
      const startLat = startLocation.lat;
      const startLng = startLocation.lng;
      const endLat = currentReportData.latitude;
      const endLng = currentReportData.longitude;
      
      try {
        const start = `${startLng},${startLat}`;
        const end = `${endLng},${endLat}`;
        
        const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${OPENROUTE_API_KEY}&start=${start}&end=${end}`;
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.features && data.features.length > 0) {
            const coordinates = data.features[0].geometry.coordinates;
            const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
            
            const summary = data.features[0].properties.segments[0];
            const distance = (summary.distance / 1000).toFixed(2);
            const duration = Math.round(summary.duration / 60);
            
            const routePolyline = L.polyline(latLngs, {
              color: '#ffd700',
              weight: 6,
              opacity: 0.9,
              lineCap: 'round',
              lineJoin: 'round'
            }).addTo(fullscreenMap);
            
            fullscreenMap._routeLine = routePolyline;
            
            addRouteMarkersToFullscreen(startLat, startLng, endLat, endLng, distance, duration);
            
            const bounds = L.latLngBounds(latLngs);
            fullscreenMap.fitBounds(bounds, { padding: [50, 50] });
          }
        }
      } catch {
        calculateSimpleRoute(fullscreenMap, startLat, startLng, endLat, endLng);
      }
    }

    function addRouteMarkersToFullscreen(startLat, startLng, endLat, endLng, distance, duration) {
      if (fullscreenMap.routeMarkers) {
        fullscreenMap.routeMarkers.forEach(marker => fullscreenMap.removeLayer(marker));
      }
      
      fullscreenMap.routeMarkers = [];
      
      const startIcon = L.divIcon({
        html: '<div style="background-color: #3498db; width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-user-shield"></i></div>',
        iconSize: [42, 42],
        iconAnchor: [21, 21]
      });
      
      const startMarker = L.marker([startLat, startLng], { icon: startIcon })
        .addTo(fullscreenMap)
        .bindPopup(`
          <div style="color: #001f3f; font-weight: bold;">
            <i class="fas fa-user-shield" style="color: #3498db;"></i> POLICE LOCATION
          </div>
          <div style="margin-top: 5px; font-size: 14px;">
            <strong>Your current location</strong><br>
            <strong>Distance to incident:</strong> ${distance} km<br>
            <strong>Estimated response time:</strong> ${duration} minutes
          </div>
        `);
      
      fullscreenMap.routeMarkers.push(startMarker);
      
      const endIcon = L.divIcon({
        html: '<div style="background-color: #2c3e50; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;"><i class="fas fa-shield-alt"></i></div>',
        iconSize: [46, 46],
        iconAnchor: [23, 23]
      });
      
      const endMarker = L.marker([endLat, endLng], { icon: endIcon })
        .addTo(fullscreenMap)
        .bindPopup(`
          <div style="color: #001f3f; font-weight: bold;">
            <i class="fas fa-shield-alt" style="color: #2c3e50;"></i> POLICE INCIDENT
          </div>
          <div style="margin-top: 5px; font-size: 14px;">
            <strong>Distance from police:</strong> ${distance} km<br>
            <strong>Estimated response time:</strong> ${duration} minutes<br>
            <strong>Responding unit:</strong> POLICE
          </div>
        `)
        .openPopup();
      
      fullscreenMap.routeMarkers.push(endMarker);
    }

    function calculateSimpleRoute(map, startLat, startLng, endLat, endLng) {
      const coordinates = [[startLat, startLng], [endLat, endLng]];
      
      const R = 6371;
      const dLat = (endLat - startLat) * Math.PI / 180;
      const dLon = (endLng - startLng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(startLat * Math.PI / 180) * Math.cos(endLat * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      const duration = Math.round(distance * 3);
      
      const routePolyline = L.polyline(coordinates, {
        color: '#ffd700',
        weight: 5,
        opacity: 0.8,
        lineCap: 'round',
        lineJoin: 'round',
        dashArray: '10, 5'
      }).addTo(map);
      
      addRouteMarkersToFullscreen(startLat, startLng, endLat, endLng, distance.toFixed(2), duration);
      
      const bounds = L.latLngBounds(coordinates);
      map.fitBounds(bounds, { padding: [50, 50] });
      
      map._routeLine = routePolyline;
    }

    function locateUserOnMap() {
      if (!fullscreenMap) return;
      
      if (userCurrentLocation) {
        fullscreenMap.setView([userCurrentLocation.lat, userCurrentLocation.lng], 16);
        
        const userIcon = L.divIcon({
          html: '<div style="background-color: #9b59b6; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-user"></i></div>',
          iconSize: [38, 38],
          iconAnchor: [19, 19]
        });
        
        if (fullscreenMap.userMarker) {
          fullscreenMap.removeLayer(fullscreenMap.userMarker);
        }
        
        fullscreenMap.userMarker = L.marker([userCurrentLocation.lat, userCurrentLocation.lng], { icon: userIcon })
          .addTo(fullscreenMap)
          .bindPopup(`
            <div style="color: #001f3f; font-weight: bold; font-size: 14px;">
              <i class="fas fa-user" style="color: #9b59b6;"></i> YOUR CURRENT LOCATION
            </div>
            <div style="margin-top: 5px; font-size: 12px;">
              Latitude: ${userCurrentLocation.lat.toFixed(6)}<br>
              Longitude: ${userCurrentLocation.lng.toFixed(6)}
            </div>
          `)
          .openPopup();
      } else {
        getUserLocation().then(location => {
          fullscreenMap.setView([location.lat, location.lng], 16);
        });
      }
    }

    function showIncidentDetails() {
      if (!fullscreenMap || !currentReportData) return;
      
      L.popup()
        .setLatLng([currentReportData.latitude, currentReportData.longitude])
        .setContent(`
          <div style="color: #001f3f; font-weight: bold; font-size: 16px;">
            <i class="fas fa-shield-alt" style="color: #2c3e50;"></i> POLICE INCIDENT DETAILS
          </div>
          <div style="margin-top: 8px; font-size: 14px;">
            <strong>Location:</strong> ${currentReportData.latitude.toFixed(6)}, ${currentReportData.longitude.toFixed(6)}<br>
            <strong>Report ID:</strong> ${currentReportId ? '#' + currentReportId.substring(0, 12) : 'N/A'}<br>
            <strong>Assigned Responders:</strong> POLICE<br>
            <strong>Status:</strong> ACTIVE
          </div>
        `)
        .openOn(fullscreenMap);
    }

    async function showRouteOnMap() {
      if (!routeMap || !currentReportData) return;
      
      if (routeLine) {
        routeMap.removeLayer(routeLine);
        routeLine = null;
      }
      
      if (routeMap.routeMarkers) {
        routeMap.routeMarkers.forEach(marker => routeMap.removeLayer(marker));
        routeMap.routeMarkers = [];
      }
      
      const startLocation = userCurrentLocation || { lat: 12.4048, lng: 121.9829 };
      const startLat = startLocation.lat;
      const startLng = startLocation.lng;
      const endLat = currentReportData.latitude;
      const endLng = currentReportData.longitude;
      
      try {
        const start = `${startLng},${startLat}`;
        const end = `${endLng},${endLat}`;
        
        const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${OPENROUTE_API_KEY}&start=${start}&end=${end}`;
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.features && data.features.length > 0) {
            const coordinates = data.features[0].geometry.coordinates;
            const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
            
            const summary = data.features[0].properties.segments[0];
            const distance = (summary.distance / 1000).toFixed(2);
            const duration = Math.round(summary.duration / 60);
            
            routeLine = L.polyline(latLngs, {
              color: '#ffd700',
              weight: 6,
              opacity: 0.9,
              lineCap: 'round',
              lineJoin: 'round'
            }).addTo(routeMap);
            
            document.getElementById('routeStatus').textContent = 'Route Calculated';
            document.getElementById('routeDistance').textContent = distance + ' km';
            document.getElementById('routeTime').textContent = duration + ' minutes';
            
            const bounds = L.latLngBounds(latLngs);
            routeMap.fitBounds(bounds, { padding: [50, 50] });
          }
        }
      } catch {
        const coordinates = [[startLat, startLng], [endLat, endLng]];
        
        const R = 6371;
        const dLat = (endLat - startLat) * Math.PI / 180;
        const dLon = (endLng - startLng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(startLat * Math.PI / 180) * Math.cos(endLat * Math.PI / 180) * 
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        const duration = Math.round(distance * 3);
        
        routeLine = L.polyline(coordinates, {
          color: '#ffd700',
          weight: 5,
          opacity: 0.8,
          lineCap: 'round',
          lineJoin: 'round',
          dashArray: '10, 5'
        }).addTo(routeMap);
        
        document.getElementById('routeStatus').textContent = 'Direct Route';
        document.getElementById('routeDistance').textContent = distance.toFixed(2) + ' km';
        document.getElementById('routeTime').textContent = duration + ' minutes';
        
        const bounds = L.latLngBounds(coordinates);
        routeMap.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    // ============ VIEW ON MAP FUNCTION ============
    function viewOnMap(latitude, longitude, reportId) {
      const lat = parseFloat(latitude);
      const lng = parseFloat(longitude);
      
      if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
        // Store the location data and report ID
        sessionStorage.setItem('viewLocation', JSON.stringify({ 
          lat: lat, 
          lng: lng 
        }));
        
        // Store the report ID
        if (reportId) {
          sessionStorage.setItem('viewReportId', reportId);
        }
        
        // Store the return URL so back button works correctly
        const token = localStorage.getItem('token');
        let returnUrl = "/police-notif.html";
        if (token) {
          returnUrl = "/police-notif.html?token=" + encodeURIComponent(token);
          sessionStorage.setItem('returnUrl', returnUrl);
        } else {
          sessionStorage.setItem('returnUrl', returnUrl);
        }
        // Redirect to the view-report page - use absolute path for deployment
        window.location.href = "/view-report.html?returnUrl=" + encodeURIComponent(returnUrl);
      } else {
        alert('Location coordinates not available or invalid.');
      }
    }

    // ============ REALTIME SUBSCRIPTION ============
    function setupRealtimeSubscription() {
      const channel = supabaseClient
        .channel('reports_changes')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'reports'
        }, (payload) => {
          console.log('Real-time update received:', payload.eventType, payload.new || payload.old);

          // Only refresh if it's a police-related incident
          if (payload.new) {
            const dbType = (payload.new.type || '').toString().toLowerCase().trim();
            if (
              dbType.includes('crime') || 
              dbType.includes('theft') || 
              dbType.includes('robbery') ||
              dbType.includes('assault') ||
              dbType.includes('police') ||
              dbType.includes('disturbance') ||
              dbType.includes('suspicious') ||
              dbType.includes('violence') ||
              dbType.includes('fight') ||
              dbType.includes('burglary') ||
              dbType.includes('vandalism') ||
              dbType.includes('harassment') ||
              dbType.includes('danger') ||
              dbType.includes('threat')
            ) {
              // Force refresh reports
              loadReports(true);
            }
          }
        })
        .subscribe((status) => {
          console.log('Realtime subscription status:', status);
        });
    }

    // ============ EVENT LISTENERS ============
    function setupEventListeners() {
      // Setup modal button event listeners
      document.getElementById('confirmRespondersBtn').onclick = assignResponders;
      document.getElementById('confirmResolveBtn').onclick = resolveIncident;
      
      // Add input validation for contact number - only digits
      const contactInput = document.getElementById('responderContact');
      if (contactInput) {
        contactInput.addEventListener('input', function(e) {
          this.value = this.value.replace(/[^0-9]/g, '');
          if (this.value.length > 11) {
            this.value = this.value.substring(0, 11);
          }
        });
      }
      
      // Add input validation for name - only letters and spaces
      const nameInput = document.getElementById('responderName');
      if (nameInput) {
        nameInput.addEventListener('input', function(e) {
          // Remove any non-letter characters (allow only letters and spaces)
          this.value = this.value.replace(/[^A-Za-z\s]/g, '');
          if (this.value.length > 20) {
            this.value = this.value.substring(0, 20);
          }
        });
      }
    }

    // ============ EXPOSE FUNCTIONS TO GLOBAL SCOPE ============
    window.openFullscreenMap = openFullscreenMap;
    window.closeFullscreenMap = closeFullscreenMap;
    window.calculateDirectRoute = calculateDirectRoute;
    window.locateUserOnMap = locateUserOnMap;
    window.showIncidentDetails = showIncidentDetails;
    window.showRouteOnMap = showRouteOnMap;
    window.zoomInRouteMap = zoomInRouteMap;
    window.zoomOutRouteMap = zoomOutRouteMap;
    window.centerOnRoute = centerOnRoute;

    // ============ CLEANUP ============
    window.addEventListener('beforeunload', () => {
      console.log('ðŸ§¹ Cleaning up...');
    });
  </script>
</body>
</html>
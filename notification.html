<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AidTracker Notifications</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.4.0/Control.FullScreen.min.js"></script>
<style>
/* All your existing CSS styles remain the same */
body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #001f3f, #003366);
  background-attachment: fixed;
  color: white;
  min-height: 100vh;
}

.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.header {
  background: rgba(0, 31, 63, 0.9);
  color: #ffd700;
  padding: 15px 20px;
  font-size: 22px;
  font-weight: 800;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffd700;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  margin-bottom: 20px;
}

.back-btn {
  background: rgba(255, 215, 0, 0.1);
  border: 1px solid rgba(255, 215, 0, 0.5);
  color: #ffd700;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.back-btn:hover {
  background: rgba(255, 215, 0, 0.2);
  transform: translateY(-2px);
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 20px 40px;
}

.notification-card {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(255, 215, 0, 0.3);
  transition: all 0.3s ease;
}

.notification-card:hover {
  background: rgba(255, 255, 255, 0.12);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.incident-type {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.motor-accident {
  background: rgba(231, 76, 60, 0.2);
  color: #e74c3c;
}

.fire-accident {
  background: rgba(243, 156, 18, 0.2);
  color: #f39c12;
}

.assault-crime {
  background: rgba(155, 89, 182, 0.2);
  color: #9b59b6;
}

.reporter-info {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.reporter-avatar {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #ffd700, #ffed4e);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #001f3f;
  font-size: 16px;
  font-weight: bold;
}

.reporter-details {
  flex: 1;
}

.reporter-name {
  font-size: 18px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 2px;
}

.reporter-time {
  font-size: 12px;
  color: #ffd700;
  opacity: 0.8;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
  background: rgba(0, 0, 0, 0.2);
  padding: 12px;
  border-radius: 8px;
}

.detail-item {
  display: flex;
  flex-direction: column;
}

.detail-label {
  font-size: 11px;
  color: #ffd700;
  opacity: 0.8;
  margin-bottom: 2px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.detail-value {
  font-size: 14px;
  font-weight: 600;
  color: #fff;
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
}

.status-pending {
  background: rgba(243, 156, 18, 0.2);
  color: #f39c12;
}

.status-investigating {
  background: rgba(52, 152, 219, 0.2);
  color: #3498db;
}

.status-resolved {
  background: rgba(46, 204, 113, 0.2);
  color: #2ecc71;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.responders-btn {
  background: #ffd700;
  color: #001f3f;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  justify-content: center;
}

.responders-btn:hover {
  background: #ffed4e;
  transform: translateY(-2px);
}

.view-btn {
  background: transparent;
  border: 1px solid #ffd700;
  color: #ffd700;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.view-btn:hover {
  background: rgba(255, 215, 0, 0.1);
  transform: translateY(-2px);
}

.resolve-btn {
  background: #2ecc71;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  justify-content: center;
}

.resolve-btn:hover {
  background: #27ae60;
  transform: translateY(-2px);
}

.loading {
  text-align: center;
  padding: 50px;
  color: #ffd700;
  font-size: 18px;
}

.loading-spinner {
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-left-color: #ffd700;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.no-reports {
  text-align: center;
  padding: 60px 20px;
  color: #fff8dc;
}

.no-reports i {
  font-size: 48px;
  color: #ffd700;
  opacity: 0.5;
  margin-bottom: 20px;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
  animation: fadeIn 0.3s ease-out;
}

.modal-content {
  background: linear-gradient(135deg, #001f3f, #003366);
  width: 90%;
  max-width: 600px;
  border-radius: 16px;
  border: 2px solid #ffd700;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  color: #ffd700;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 20px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.modal-section {
  margin-bottom: 25px;
}

.modal-section-title {
  color: #ffd700;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-input, .modal-select, .modal-textarea {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,215,0,0.5);
  color: white;
  font-size: 16px;
  outline: none;
  font-family: inherit;
  margin-bottom: 10px;
}

.modal-textarea {
  min-height: 100px;
  resize: vertical;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  margin-top: 30px;
}

.modal-btn-primary {
  flex: 1;
  background: #ffd700;
  color: #001f3f;
  border: none;
  padding: 14px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.modal-btn-primary:hover {
  background: #ffed4e;
}

.modal-btn-secondary {
  flex: 1;
  background: transparent;
  border: 2px solid #ffd700;
  color: #ffd700;
  padding: 14px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.modal-btn-secondary:hover {
  background: rgba(255, 215, 0, 0.1);
}

.responders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.responder-option {
  background: rgba(0, 0, 0, 0.2);
  border: 2px solid rgba(255, 215, 0, 0.3);
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.responder-option:hover {
  background: rgba(255, 215, 0, 0.1);
  border-color: #ffd700;
}

.responder-option.selected {
  background: rgba(255, 215, 0, 0.2);
  border-color: #ffd700;
}

.responder-option.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 5px;
  right: 5px;
  background: #ffd700;
  color: #001f3f;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

.responder-name {
  font-weight: 700;
  color: #fff;
  margin-bottom: 4px;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.responder-unit {
  color: #ffd700;
  font-size: 12px;
  margin-bottom: 4px;
  padding: 2px 8px;
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.3);
  display: inline-block;
}

.mdrrmo-unit {
  background: rgba(52, 152, 219, 0.2);
  color: #3498db;
}

.bfp-unit {
  background: rgba(231, 76, 60, 0.2);
  color: #e74c3c;
}

.police-unit {
  background: rgba(46, 204, 113, 0.2);
  color: #2ecc71;
}

.route-map-container {
  height: 400px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid rgba(255, 215, 0, 0.3);
  margin-bottom: 20px;
  position: relative;
}

#routeMap {
  width: 100%;
  height: 100%;
}

/* Remove Leaflet default controls */
.leaflet-control-container .leaflet-control-zoom {
  display: none !important;
}

.leaflet-control-attribution {
  display: none !important;
}

/* Custom map controls */
.custom-map-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.custom-map-control-btn {
  background: rgba(0, 31, 63, 0.9);
  border: 1px solid rgba(255, 215, 0, 0.5);
  color: #ffd700;
  width: 35px;
  height: 35px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.custom-map-control-btn:hover {
  background: rgba(255, 215, 0, 0.2);
  transform: scale(1.1);
  border-color: #ffd700;
}

.route-info {
  background: rgba(0, 0, 0, 0.3);
  padding: 15px;
  border-radius: 10px;
  margin-top: 15px;
}

.route-info-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.route-info-label {
  color: #ffd700;
  font-weight: 600;
  font-size: 14px;
}

.route-info-value {
  color: white;
  font-weight: 600;
  font-size: 14px;
}

.quick-route-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  justify-content: center;
  margin-top: 10px;
}

.quick-route-btn:hover {
  background: #2980b9;
  transform: translateY(-2px);
}

.fullscreen-map-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 20000;
  background: #001f3f;
  display: none;
}

.fullscreen-header {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 31, 63, 0.9);
  color: #ffd700;
  padding: 15px 20px;
  z-index: 1000;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid #ffd700;
}

.fullscreen-close {
  background: rgba(255, 215, 0, 0.1);
  border: 1px solid rgba(255, 215, 0, 0.5);
  color: #ffd700;
  padding: 10px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
 
  font-size: 12px;
}

.fullscreen-close:hover {
  background: rgba(255, 215, 0, 0.2);
}

#fullscreenMap {
  width: 100%;
  height: 100%;
}

.map-controls {
  position: absolute;
  top: 80px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.map-control-btn {
  background: rgba(0, 31, 63, 0.9);
  border: 2px solid #ffd700;
  color: #ffd700;
  padding: 10px 15px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 180px;
}

.map-control-btn:hover {
  background: rgba(255, 215, 0, 0.1);
  transform: translateY(-2px);
}

.custom-responder-input {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 215, 0, 0.3);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
}

.custom-responder-input label {
  display: block;
  color: #ffd700;
  font-size: 12px;
  margin-bottom: 5px;
  font-weight: 600;
}

@media (max-width: 768px) {
  .header {
    font-size: 18px;
    padding: 12px 15px;
  }
  
  .back-btn {
    padding: 8px 15px;
    font-size: 14px;
  }
  
  .container {
    padding: 0 15px 30px;
  }
  
  .details-grid {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .reporter-info {
    flex-direction: column;
    text-align: center;
  }
  
  .responders-grid {
    grid-template-columns: 1fr;
  }
  
  .modal-buttons {
    flex-direction: column;
  }
  
  .route-map-container {
    height: 300px;
  }
  
  .input-row {
    flex-direction: column;
  }
  
  .map-controls {
    top: 100px;
    right: 10px;
  }
  
  .map-control-btn {
    min-width: 160px;
    padding: 8px 12px;
    font-size: 14px;
  }
}
</style>
</head>

<body>
  <div class="header">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i> Home
    </button>
    <span>ðŸ”” Notifications</span>
    <div style="width: 60px;"></div>
  </div>

  <div class="container">
    <div id="status" class="loading">
      <div class="loading-spinner"></div>
      <span>Loading reports from Supabase...</span>
    </div>
    
    <div id="notificationList"></div>
  </div>

  <div id="fullscreenMapContainer" class="fullscreen-map-container">
    <div class="fullscreen-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-map-marked-alt"></i>
        <span>Emergency Response Navigation</span>
      </div>
      <button class="fullscreen-close" onclick="closeFullscreenMap()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div id="fullscreenMap"></div>
    
    <div class="map-controls">
      <button class="map-control-btn" onclick="calculateDirectRoute()">
        <i class="fas fa-route"></i> Show Route
      </button>
      <button class="map-control-btn" onclick="locateUserOnMap()">
        <i class="fas fa-crosshairs"></i> My Location
      </button>
      <button class="map-control-btn" onclick="showIncidentDetails()">
        <i class="fas fa-info-circle"></i> Incident Info
      </button>
    </div>
  </div>

  <div id="respondersModal" class="modal-overlay">
    <div class="modal-content glass">
      <div class="modal-header">
        <i class="fas fa-users"></i> Assign Responders
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-id-card"></i> Incident Details
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
          <div style="color: #ffd700; font-size: 12px; margin-bottom: 4px;">Incident ID</div>
          <div id="modalIncidentId" style="color: white; font-weight: bold; font-size: 16px;"></div>
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
          <div style="color: #ffd700; font-size: 12px; margin-bottom: 4px;">Reporter</div>
          <div id="modalReporterName" style="color: white; font-size: 16px;"></div>
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-user-shield"></i> Available Responder Units
        </div>
        <div class="responders-grid" id="respondersGrid"></div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-user-plus"></i> Add Custom Responder
        </div>
        <div class="custom-responder-input">
          <label for="responderName">Responder Name</label>
          <input type="text" id="responderName" class="modal-input" placeholder="Enter responder name">
          
          <label for="responderContact">Contact Number</label>
          <input type="text" id="responderContact" class="modal-input" placeholder="Enter contact number">
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-sticky-note"></i> Assignment Notes
        </div>
        <textarea id="responderNotes" class="modal-textarea" placeholder="Enter assignment instructions or notes..."></textarea>
      </div>
      
      <div class="modal-buttons">
        <button id="confirmRespondersBtn" class="modal-btn-primary">
          <i class="fas fa-check"></i> Assign Responders
        </button>
        <button onclick="closeModal('respondersModal')" class="modal-btn-secondary">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>

  <div id="quickRouteModal" class="modal-overlay">
    <div class="modal-content glass">
      <div class="modal-header">
        <i class="fas fa-route"></i> Navigation to Incident
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-map-marker-alt"></i> Incident Location
        </div>
        <div id="routeDestination" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; color: white; font-size: 16px; margin-bottom: 15px;">
          Loading location...
        </div>
        
        <div class="route-map-container">
          <div id="routeMap"></div>
          <!-- Custom map controls -->
          <div class="custom-map-controls">
            <button class="custom-map-control-btn" onclick="zoomInRouteMap()" title="Zoom In">
              <i class="fas fa-plus"></i>
            </button>
            <button class="custom-map-control-btn" onclick="zoomOutRouteMap()" title="Zoom Out">
              <i class="fas fa-minus"></i>
            </button>
            <button class="custom-map-control-btn" onclick="centerOnRoute()" title="Center on Incident">
              <i class="fas fa-bullseye"></i>
            </button>
          </div>
        </div>
        
        <div class="route-info">
          <div class="route-info-item">
            <span class="route-info-label">Route Status:</span>
            <span id="routeStatus" class="route-info-value">Click "Show Route" to calculate</span>
          </div>
          <div class="route-info-item">
            <span class="route-info-label">Assigned Units:</span>
            <span id="assignedUnits" class="route-info-value">None</span>
          </div>
          <div class="route-info-item">
            <span class="route-info-label">Distance:</span>
            <span id="routeDistance" class="route-info-value">-- km</span>
          </div>
          <div class="route-info-item">
            <span class="route-info-label">Estimated Time:</span>
            <span id="routeTime" class="route-info-value">-- minutes</span>
          </div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button onclick="showRouteOnMap()" class="modal-btn-primary" style="background: #3498db;">
          <i class="fas fa-route"></i> Show Route
        </button>
        <button onclick="openFullscreenMap()" class="modal-btn-secondary" style="background: #9b59b6;">
          <i class="fas fa-expand"></i> Fullscreen Map
        </button>
        <button onclick="closeModal('quickRouteModal')" class="modal-btn-secondary">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <div id="resolveModal" class="modal-overlay">
    <div class="modal-content glass">
      <div class="modal-header">
        <i class="fas fa-check-circle"></i> Resolve Incident
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-info-circle"></i> Incident Details
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
          <div style="color: #ffd700; font-size: 12px; margin-bottom: 4px;">Incident ID</div>
          <div id="resolveIncidentId" style="color: white; font-weight: bold; font-size: 16px;"></div>
        </div>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-check-square"></i> Resolution Status
        </div>
        <select id="resolutionStatus" class="modal-select">
          <option value="resolved">Resolved - Situation Under Control</option>
          <option value="assisted">Assisted - Provided Necessary Aid</option>
          <option value="transported">Transported - Patient Transported to Hospital</option>
          <option value="handed_over">Handed Over - Transferred to Other Agency</option>
          <option value="false_alarm">False Alarm - No Action Required</option>
        </select>
      </div>
      
      <div class="modal-section">
        <div class="modal-section-title">
          <i class="fas fa-sticky-note"></i> Resolution Notes
        </div>
        <textarea id="resolutionNotes" class="modal-textarea" placeholder="Describe what actions were taken and the outcome..."></textarea>
      </div>
      
      <div class="modal-buttons">
        <button id="confirmResolveBtn" class="modal-btn-primary" style="background: #2ecc71;">
          <i class="fas fa-check-double"></i> Mark as Resolved
        </button>
        <button onclick="closeModal('resolveModal')" class="modal-btn-secondary">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>
<script>
// ============ GLOBAL VARIABLES ============
let currentReportId = null;
let currentReportData = null;
let selectedResponders = [];
let tableColumns = [];
let routeMap = null;
let fullscreenMap = null;
let routeLine = null;
let assignedRespondersList = [];
let userCurrentLocation = null;

const OPENROUTE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImJjYzMxOGQ0MGYwMTQ3YTBhZDJlNWU3ZDkxOGNhNGJiIiwiaCI6Im11cm11cjY0In0=';

const defaultRespondersData = [
  { 
    id: 'mdrrmo', 
    name: 'MDRRMO Unit', 
    unit: 'MDRRMO', 
    icon: 'fa-truck-medical',
    unitClass: 'mdrrmo-unit'
  },
  { 
    id: 'bfp', 
    name: 'BFP Unit', 
    unit: 'BFP', 
    icon: 'fa-fire',
    unitClass: 'bfp-unit'
  },
  { 
    id: 'police', 
    name: 'Police Unit', 
    unit: 'POLICE', 
    icon: 'fa-shield-alt',
    unitClass: 'police-unit'
  }
];

const SUPABASE_URL = 'https://gwvepxupoxyyydnisulb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3dmVweHVwb3h5eXlkbmlzdWxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDE4ODcsImV4cCI6MjA4MDM3Nzg4N30.Ku9SXTAKNMvHilgEpxj5HcVA-0TPt4ziuEq0Irao5Qc';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============ HELPER FUNCTIONS ============
async function getUserLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      userCurrentLocation = { lat: 12.4048, lng: 121.9829 };
      resolve(userCurrentLocation);
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userCurrentLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        resolve(userCurrentLocation);
      },
      () => {
        userCurrentLocation = { lat: 12.4048, lng: 121.9829 };
        resolve(userCurrentLocation);
      }
    );
  });
}

function goBack() {
  window.location.href = "index.html";
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
  
  if (modalId === 'quickRouteModal' && currentReportData) {
    setTimeout(() => {
      initRouteMap();
    }, 100);
  }
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  if (modalId === 'respondersModal') {
    selectedResponders = [];
    updateRespondersGrid();
    document.getElementById('responderName').value = '';
    document.getElementById('responderContact').value = '';
    document.getElementById('responderNotes').value = '';
  }
  if (modalId === 'quickRouteModal') {
    if (routeLine && routeMap) {
      routeMap.removeLayer(routeLine);
      routeLine = null;
    }
    if (routeMap) {
      routeMap.remove();
      routeMap = null;
    }
  }
}

// ============ MAP FUNCTIONS ============
function openFullscreenMap() {
  if (!currentReportData) return;
  
  document.getElementById('fullscreenMapContainer').style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  setTimeout(() => {
    initFullscreenMap();
  }, 100);
}

function closeFullscreenMap() {
  document.getElementById('fullscreenMapContainer').style.display = 'none';
  document.body.style.overflow = 'auto';
  
  if (fullscreenMap) {
    fullscreenMap.remove();
    fullscreenMap = null;
  }
}

function initFullscreenMap() {
  if (!currentReportData || !document.getElementById('fullscreenMap')) return;
  
  const centerLat = userCurrentLocation ? userCurrentLocation.lat : currentReportData.latitude;
  const centerLng = userCurrentLocation ? userCurrentLocation.lng : currentReportData.longitude;
  
  // Initialize map with NO default zoom controls
  fullscreenMap = L.map('fullscreenMap', {
    zoomControl: false, // Disable default zoom controls
    attributionControl: false, // Disable attribution
    dragging: true,
    touchZoom: true,
    doubleClickZoom: true,
    scrollWheelZoom: true,
    boxZoom: true,
    keyboard: true,
    tap: true
  }).setView([centerLat, centerLng], 14);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(fullscreenMap);
  
  const incidentIcon = L.divIcon({
    html: '<div style="background-color: #e74c3c; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"><i class="fas fa-exclamation-triangle"></i></div>',
    iconSize: [46, 46],
    iconAnchor: [23, 23]
  });
  
  L.marker([currentReportData.latitude, currentReportData.longitude], { icon: incidentIcon })
    .addTo(fullscreenMap)
    .bindPopup(`
      <div style="color: #001f3f; font-weight: bold; font-size: 16px;">
        <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> EMERGENCY INCIDENT
      </div>
      <div style="margin-top: 8px; font-size: 14px;">
        <strong>Location:</strong> ${currentReportData.latitude.toFixed(6)}, ${currentReportData.longitude.toFixed(6)}<br>
        <strong>Status:</strong> INVESTIGATING<br>
        <strong>Assigned:</strong> ${assignedRespondersList.length > 0 ? assignedRespondersList.join(', ') : 'No responders'}
      </div>
    `)
    .openPopup();
  
  if (userCurrentLocation) {
    const userIcon = L.divIcon({
      html: '<div style="background-color: #3498db; width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-user-shield"></i></div>',
      iconSize: [42, 42],
      iconAnchor: [21, 21]
    });
    
    L.marker([userCurrentLocation.lat, userCurrentLocation.lng], { icon: userIcon })
      .addTo(fullscreenMap)
      .bindPopup(`
        <div style="color: #001f3f; font-weight: bold; font-size: 16px;">
          <i class="fas fa-user-shield" style="color: #3498db;"></i> YOUR LOCATION
        </div>
        <div style="margin-top: 8px; font-size: 14px;">
          <strong>Current responder position</strong><br>
          <strong>Coordinates:</strong> ${userCurrentLocation.lat.toFixed(6)}, ${userCurrentLocation.lng.toFixed(6)}
        </div>
      `);
  }
}

function initRouteMap() {
  if (!currentReportData || !document.getElementById('routeMap')) return;
  
  const centerLat = userCurrentLocation ? userCurrentLocation.lat : currentReportData.latitude;
  const centerLng = userCurrentLocation ? userCurrentLocation.lng : currentReportData.longitude;
  
  // Initialize map with NO default zoom controls
  routeMap = L.map('routeMap', {
    zoomControl: false, // Disable default zoom controls
    attributionControl: false, // Disable attribution
    dragging: true,
    touchZoom: true,
    doubleClickZoom: true,
    scrollWheelZoom: true,
    boxZoom: true
  }).setView([centerLat, centerLng], 13);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(routeMap);
  
  const destIcon = L.divIcon({
    html: '<div style="background-color: #e74c3c; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-exclamation-triangle"></i></div>',
    iconSize: [38, 38],
    iconAnchor: [19, 19]
  });
  
  L.marker([currentReportData.latitude, currentReportData.longitude], { icon: destIcon })
    .addTo(routeMap)
    .bindPopup(`
      <b>Incident Location</b><br>
      Emergency site requiring response<br>
      ${assignedRespondersList.length > 0 ? 'Assigned: ' + assignedRespondersList.join(', ') : 'No responders assigned'}
    `)
    .openPopup();
  
  if (userCurrentLocation) {
    const startIcon = L.divIcon({
      html: '<div style="background-color: #3498db; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"><i class="fas fa-user-shield"></i></div>',
      iconSize: [34, 34],
      iconAnchor: [17, 17]
    });
    
    L.marker([userCurrentLocation.lat, userCurrentLocation.lng], { icon: startIcon })
      .addTo(routeMap)
      .bindPopup('<b>Your Current Location</b><br>Responder position');
  }
}

// Custom map control functions for route map
function zoomInRouteMap() {
  if (routeMap) {
    routeMap.zoomIn();
  }
}

function zoomOutRouteMap() {
  if (routeMap) {
    routeMap.zoomOut();
  }
}

function centerOnRoute() {
  if (routeMap && currentReportData) {
    routeMap.setView([currentReportData.latitude, currentReportData.longitude], 15);
  }
}

async function calculateDirectRoute() {
  if (!fullscreenMap || !currentReportData) return;
  
  if (fullscreenMap._routeLine) {
    fullscreenMap.removeLayer(fullscreenMap._routeLine);
  }
  
  if (fullscreenMap.routeMarkers) {
    fullscreenMap.routeMarkers.forEach(marker => fullscreenMap.removeLayer(marker));
    fullscreenMap.routeMarkers = [];
  }
  
  const startLocation = userCurrentLocation || { lat: 12.4048, lng: 121.9829 };
  const startLat = startLocation.lat;
  const startLng = startLocation.lng;
  const endLat = currentReportData.latitude;
  const endLng = currentReportData.longitude;
  
  try {
    const start = `${startLng},${startLat}`;
    const end = `${endLng},${endLat}`;
    
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${OPENROUTE_API_KEY}&start=${start}&end=${end}`;
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.features && data.features.length > 0) {
        const coordinates = data.features[0].geometry.coordinates;
        const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
        
        const summary = data.features[0].properties.segments[0];
        const distance = (summary.distance / 1000).toFixed(2);
        const duration = Math.round(summary.duration / 60);
        
        const routePolyline = L.polyline(latLngs, {
          color: '#ffd700',
          weight: 6,
          opacity: 0.9,
          lineCap: 'round',
          lineJoin: 'round'
        }).addTo(fullscreenMap);
        
        fullscreenMap._routeLine = routePolyline;
        
        addRouteMarkersToFullscreen(startLat, startLng, endLat, endLng, distance, duration);
        
        const bounds = L.latLngBounds(latLngs);
        fullscreenMap.fitBounds(bounds, { padding: [50, 50] });
      }
    }
  } catch {
    calculateSimpleRoute(fullscreenMap, startLat, startLng, endLat, endLng);
  }
}

function addRouteMarkersToFullscreen(startLat, startLng, endLat, endLng, distance, duration) {
  if (fullscreenMap.routeMarkers) {
    fullscreenMap.routeMarkers.forEach(marker => fullscreenMap.removeLayer(marker));
  }
  
  fullscreenMap.routeMarkers = [];
  
  const startIcon = L.divIcon({
    html: '<div style="background-color: #3498db; width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-user-shield"></i></div>',
    iconSize: [42, 42],
    iconAnchor: [21, 21]
  });
  
  const startMarker = L.marker([startLat, startLng], { icon: startIcon })
    .addTo(fullscreenMap)
    .bindPopup(`
      <div style="color: #001f3f; font-weight: bold;">
        <i class="fas fa-user-shield" style="color: #3498db;"></i> RESPONDER LOCATION
      </div>
      <div style="margin-top: 5px; font-size: 14px;">
        <strong>Your current location</strong><br>
        <strong>Distance to incident:</strong> ${distance} km<br>
        <strong>Estimated time:</strong> ${duration} minutes
      </div>
    `);
  
  fullscreenMap.routeMarkers.push(startMarker);
  
  const endIcon = L.divIcon({
    html: '<div style="background-color: #e74c3c; width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;"><i class="fas fa-exclamation-triangle"></i></div>',
    iconSize: [46, 46],
    iconAnchor: [23, 23]
  });
  
  const endMarker = L.marker([endLat, endLng], { icon: endIcon })
    .addTo(fullscreenMap)
    .bindPopup(`
      <div style="color: #001f3f; font-weight: bold;">
        <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> EMERGENCY INCIDENT
      </div>
      <div style="margin-top: 5px; font-size: 14px;">
        <strong>Distance from you:</strong> ${distance} km<br>
        <strong>Estimated travel time:</strong> ${duration} minutes<br>
        <strong>Assigned units:</strong> ${assignedRespondersList.length > 0 ? assignedRespondersList.join(', ') : 'None'}
      </div>
    `)
    .openPopup();
  
  fullscreenMap.routeMarkers.push(endMarker);
}

function calculateSimpleRoute(map, startLat, startLng, endLat, endLng) {
  const coordinates = [[startLat, startLng], [endLat, endLng]];
  
  const R = 6371;
  const dLat = (endLat - startLat) * Math.PI / 180;
  const dLon = (endLng - startLng) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(startLat * Math.PI / 180) * Math.cos(endLat * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  const duration = Math.round(distance * 3);
  
  const routePolyline = L.polyline(coordinates, {
    color: '#ffd700',
    weight: 5,
    opacity: 0.8,
    lineCap: 'round',
    lineJoin: 'round',
    dashArray: '10, 5'
  }).addTo(map);
  
  addRouteMarkersToFullscreen(startLat, startLng, endLat, endLng, distance.toFixed(2), duration);
  
  const bounds = L.latLngBounds(coordinates);
  map.fitBounds(bounds, { padding: [50, 50] });
  
  map._routeLine = routePolyline;
}

function locateUserOnMap() {
  if (!fullscreenMap) return;
  
  if (userCurrentLocation) {
    fullscreenMap.setView([userCurrentLocation.lat, userCurrentLocation.lng], 16);
    
    const userIcon = L.divIcon({
      html: '<div style="background-color: #9b59b6; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;"><i class="fas fa-user"></i></div>',
      iconSize: [38, 38],
      iconAnchor: [19, 19]
    });
    
    if (fullscreenMap.userMarker) {
      fullscreenMap.removeLayer(fullscreenMap.userMarker);
    }
    
    fullscreenMap.userMarker = L.marker([userCurrentLocation.lat, userCurrentLocation.lng], { icon: userIcon })
      .addTo(fullscreenMap)
      .bindPopup(`
        <div style="color: #001f3f; font-weight: bold; font-size: 14px;">
          <i class="fas fa-user" style="color: #9b59b6;"></i> YOUR CURRENT LOCATION
        </div>
        <div style="margin-top: 5px; font-size: 12px;">
          Latitude: ${userCurrentLocation.lat.toFixed(6)}<br>
          Longitude: ${userCurrentLocation.lng.toFixed(6)}
        </div>
      `)
      .openPopup();
  } else {
    getUserLocation().then(location => {
      fullscreenMap.setView([location.lat, location.lng], 16);
    });
  }
}

function showIncidentDetails() {
  if (!fullscreenMap || !currentReportData) return;
  
  L.popup()
    .setLatLng([currentReportData.latitude, currentReportData.longitude])
    .setContent(`
      <div style="color: #001f3f; font-weight: bold; font-size: 16px;">
        <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> INCIDENT DETAILS
      </div>
      <div style="margin-top: 8px; font-size: 14px;">
        <strong>Location:</strong> ${currentReportData.latitude.toFixed(6)}, ${currentReportData.longitude.toFixed(6)}<br>
        <strong>Report ID:</strong> ${currentReportId ? '#' + currentReportId.substring(0, 12) : 'N/A'}<br>
        <strong>Assigned Responders:</strong> ${assignedRespondersList.length > 0 ? assignedRespondersList.join(', ') : 'None'}<br>
        <strong>Status:</strong> ACTIVE
      </div>
    `)
    .openOn(fullscreenMap);
}

async function showRouteOnMap() {
  if (!routeMap || !currentReportData) return;
  
  if (routeLine) {
    routeMap.removeLayer(routeLine);
    routeLine = null;
  }
  
  if (routeMap.routeMarkers) {
    routeMap.routeMarkers.forEach(marker => routeMap.removeLayer(marker));
    routeMap.routeMarkers = [];
  }
  
  const startLocation = userCurrentLocation || { lat: 12.4048, lng: 121.9829 };
  const startLat = startLocation.lat;
  const startLng = startLocation.lng;
  const endLat = currentReportData.latitude;
  const endLng = currentReportData.longitude;
  
  try {
    const start = `${startLng},${startLat}`;
    const end = `${endLng},${endLat}`;
    
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${OPENROUTE_API_KEY}&start=${start}&end=${end}`;
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.features && data.features.length > 0) {
        const coordinates = data.features[0].geometry.coordinates;
        const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
        
        const summary = data.features[0].properties.segments[0];
        const distance = (summary.distance / 1000).toFixed(2);
        const duration = Math.round(summary.duration / 60);
        
        routeLine = L.polyline(latLngs, {
          color: '#ffd700',
          weight: 6,
          opacity: 0.9,
          lineCap: 'round',
          lineJoin: 'round'
        }).addTo(routeMap);
        
        document.getElementById('routeStatus').textContent = 'Route Calculated';
        document.getElementById('routeDistance').textContent = distance + ' km';
        document.getElementById('routeTime').textContent = duration + ' minutes';
        
        const bounds = L.latLngBounds(latLngs);
        routeMap.fitBounds(bounds, { padding: [50, 50] });
      }
    }
  } catch {
    const coordinates = [[startLat, startLng], [endLat, endLng]];
    
    const R = 6371;
    const dLat = (endLat - startLat) * Math.PI / 180;
    const dLon = (endLng - startLng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(startLat * Math.PI / 180) * Math.cos(endLat * Math.PI / 180) * 
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    const duration = Math.round(distance * 3);
    
    routeLine = L.polyline(coordinates, {
      color: '#ffd700',
      weight: 5,
      opacity: 0.8,
      lineCap: 'round',
      lineJoin: 'round',
      dashArray: '10, 5'
    }).addTo(routeMap);
    
    document.getElementById('routeStatus').textContent = 'Direct Route';
    document.getElementById('routeDistance').textContent = distance.toFixed(2) + ' km';
    document.getElementById('routeTime').textContent = duration + ' minutes';
    
    const bounds = L.latLngBounds(coordinates);
    routeMap.fitBounds(bounds, { padding: [50, 50] });
  }
}

// ============ MAIN FUNCTIONS ============
async function getTableColumns() {
  try {
    const { data, error } = await supabase
      .from('reports')
      .select('*')
      .limit(1);
    
    if (error) throw error;
    
    if (data && data.length > 0) {
      tableColumns = Object.keys(data[0]);
      return true;
    }
    return false;
  } catch {
    tableColumns = ['id', 'type', 'latitude', 'longitude', 'reporter', 'status', 'created_at', 'assigned_responders', 'assigned_unit', 'contact'];
    return false;
  }
}

async function loadReports() {
  const statusEl = document.getElementById('status');
  const container = document.getElementById('notificationList');
  
  try {
    await getTableColumns();
    
    // Always try to get all three responder columns
    const selectQuery = 'id, type, latitude, longitude, reporter, status, created_at, assigned_responders, assigned_unit, contact';
    
    const { data, error } = await supabase
      .from('reports')
      .select(selectQuery)
      .order('created_at', { ascending: false });
    
    if (error) {
      // If error, try without the new columns
      const { data: simpleData, error: simpleError } = await supabase
        .from('reports')
        .select('id, type, latitude, longitude, reporter, status, created_at')
        .order('created_at', { ascending: false });
      
      if (simpleError) throw simpleError;
      
      data = simpleData;
    }
    
    if (!data || data.length === 0) {
      statusEl.innerHTML = `
        <div class="no-reports">
          <i class="fas fa-bell-slash"></i>
          <h3 style="font-size: 24px; color: #ffd700; margin-bottom: 10px;">No Reports Yet</h3>
          <p style="color: #fff8dc; opacity: 0.8;">Emergency reports will appear here once submitted.</p>
        </div>
      `;
      return;
    }
    
    statusEl.style.display = 'none';
    container.innerHTML = '';
    
    for (const report of data) {
      renderNotificationCard(report);
    }
    
  } catch (error) {
    console.error('Error loading reports:', error);
    statusEl.innerHTML = `
      <div class="no-reports">
        <i class="fas fa-exclamation-triangle"></i>
        <h3 style="font-size: 24px; color: #ff6b6b; margin-bottom: 10px;">Error Loading Reports</h3>
        <p style="color: #fff8dc; opacity: 0.8;">Unable to load reports. Please try again.</p>
        <button onclick="loadReports()" style="
          margin-top: 20px;
          padding: 10px 20px;
          background: #ffd700;
          color: #001f3f;
          border: none;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
        ">
          <i class="fas fa-redo"></i> Retry
        </button>
      </div>
    `;
  }
}

function renderNotificationCard(report) {
  const container = document.getElementById('notificationList');
  
  let incidentType = 'motor_accident';
  let incidentTypeName = 'MOTOR ACCIDENT';
  let incidentClass = 'motor-accident';
  
  const dbType = (report.type || '').toString().toLowerCase().trim();
  
  if (dbType.includes('fire')) {
    incidentType = 'fire_accident';
    incidentTypeName = 'FIRE ACCIDENT';
    incidentClass = 'fire-accident';
  } else if (dbType.includes('assault') || dbType.includes('crime')) {
    incidentType = 'assault_crime';
    incidentTypeName = 'ASSAULT CRIME';
    incidentClass = 'assault-crime';
  }
  
  const reporterName = report.reporter || report.reporter_name || report.name || 'Anonymous';
  const reporterInitials = reporterName.charAt(0).toUpperCase();
  
  const reportDate = new Date(report.created_at || report.timestamp || new Date());
  const timeString = reportDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const dateString = reportDate.toLocaleDateString();
  const fullDateTime = reportDate.toLocaleString();
  
  const locationText = report.latitude && report.longitude 
    ? `${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}`
    : 'Location not specified';
  
  const status = (report.status || 'pending').toLowerCase();
  let statusClass = 'status-pending';
  let statusText = 'Pending';
  
  if (status === 'investigating' || status === 'assigned') {
    statusClass = 'status-investigating';
    statusText = 'Investigating';
  } else if (status === 'resolved') {
    statusClass = 'status-resolved';
    statusText = 'Resolved';
  }
  
  // Get responder data from separate columns
  const assignedResponders = report.assigned_responders || '';
  const assignedUnit = report.assigned_unit || '';
  const contact = report.contact || '';
  
  let displayText = '';
  if (assignedResponders) {
    displayText = assignedResponders;
    if (assignedUnit) {
      displayText += ` (${assignedUnit})`;
    }
    if (contact) {
      displayText += ` - ${contact}`;
    }
  }
  
  const hasAssignedResponders = displayText.trim() !== '';
  
  const card = document.createElement('div');
  card.className = 'notification-card glass';
  card.dataset.reportId = report.id;
  card.dataset.assignedResponders = displayText;
  
  let actionButtonsHTML = '';
  if (status === 'pending') {
    actionButtonsHTML = `
      <button class="responders-btn" onclick="openRespondersModal('${report.id}', '${reporterName.replace(/'/g, "\\'")}')">
        <i class="fas fa-users"></i> ASSIGN RESPONDERS
      </button>
      <button class="view-btn" onclick="viewOnMap(${report.latitude}, ${report.longitude}, '${report.id}')">
        <i class="fas fa-map-marker-alt"></i> VIEW ON MAP
      </button>
    `;
  } else if (status === 'investigating' || status === 'assigned') {
    actionButtonsHTML = `
      <button class="quick-route-btn" onclick="openQuickRouteModal('${report.id}', ${report.latitude}, ${report.longitude}, '${displayText.replace(/'/g, "\\'")}')">
        <i class="fas fa-route"></i> NAVIGATE TO INCIDENT
      </button>
      <button class="resolve-btn" onclick="openResolveModal('${report.id}')">
        <i class="fas fa-check-circle"></i> RESOLVE
      </button>
    `;
  } else {
    actionButtonsHTML = `
      <button class="view-btn" onclick="viewOnMap(${report.latitude}, ${report.longitude}, '${report.id}')" style="flex: 1;">
        <i class="fas fa-map-marker-alt"></i> VIEW LOCATION
      </button>
    `;
  }
  
  card.innerHTML = `
    <div class="incident-type ${incidentClass}">
      <i class="fas ${incidentType === 'motor_accident' ? 'fa-car-crash' : 
                     incidentType === 'fire_accident' ? 'fa-fire' : 
                     'fa-user-injured'}"></i> ${incidentTypeName}
    </div>
    
    <div class="reporter-info">
      <div class="reporter-avatar">
        ${reporterInitials}
      </div>
      <div class="reporter-details">
        <div class="reporter-name">${reporterName}</div>
        <div class="reporter-time">${fullDateTime}</div>
      </div>
    </div>
    
    <div class="details-grid">
      <div class="detail-item">
        <span class="detail-label">Time</span>
        <span class="detail-value">${timeString}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Date</span>
        <span class="detail-value">${dateString}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Location</span>
        <span class="detail-value">${locationText}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Report ID</span>
        <span class="detail-value">${report.id ? '#' + report.id.substring(0, 8) : 'N/A'}</span>
      </div>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 215, 0, 0.05); border-radius: 8px; border-left: 3px solid #ffd700;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <i class="fas fa-user-shield" style="color: #ffd700; font-size: 14px;"></i>
        <span style="color: #ffd700; font-size: 12px; font-weight: bold;">ASSIGNED RESPONDERS:</span>
      </div>
      <div id="assignedRespondersDisplay-${report.id}" style="color: white; font-size: 14px; font-weight: 600;">
        ${hasAssignedResponders ? displayText : 'No responders assigned yet'}
      </div>
    </div>
    
    <div style="margin-bottom: 15px;">
      <span style="color: #fff8dc; font-size: 12px; margin-right: 8px;">Status:</span>
      <span class="status-badge ${statusClass}">${statusText}</span>
    </div>
    
    <div class="action-buttons">
      ${actionButtonsHTML}
    </div>
  `;
  
  container.appendChild(card);
}

// ============ FIXED VIEW ON MAP FUNCTION ============
function viewOnMap(latitude, longitude, reportId) {
  // Convert to numbers if they're strings
  const lat = parseFloat(latitude);
  const lng = parseFloat(longitude);
  
  if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
    // Store the location data and report ID
    sessionStorage.setItem('viewLocation', JSON.stringify({ 
      lat: lat, 
      lng: lng 
    }));
    
    // Store the report ID
    if (reportId) {
      sessionStorage.setItem('viewReportId', reportId);
    }
    
    // Redirect to the view-report page
    window.location.href = "view-report.html";
  } else {
    alert('Location coordinates not available or invalid.');
  }
}

function openRespondersModal(reportId, reporterName) {
  currentReportId = reportId;
  
  document.getElementById('modalIncidentId').textContent = reportId ? '#' + reportId.substring(0, 12) : 'N/A';
  document.getElementById('modalReporterName').textContent = reporterName;
  
  updateRespondersGrid();
  openModal('respondersModal');
}

function updateRespondersGrid() {
  const grid = document.getElementById('respondersGrid');
  grid.innerHTML = '';
  
  defaultRespondersData.forEach(responder => {
    const isSelected = selectedResponders.includes(responder.id);
    const option = document.createElement('div');
    option.className = `responder-option ${isSelected ? 'selected' : ''}`;
    option.innerHTML = `
      <div class="responder-name">
        <i class="fas ${responder.icon}"></i> ${responder.name}
      </div>
      <div class="responder-unit ${responder.unitClass}">${responder.unit}</div>
    `;
    option.onclick = () => toggleResponder(responder.id);
    grid.appendChild(option);
  });
}

function toggleResponder(responderId) {
  if (selectedResponders.includes(responderId)) {
    selectedResponders = selectedResponders.filter(id => id !== responderId);
  } else {
    selectedResponders.push(responderId);
  }
  updateRespondersGrid();
}

async function assignResponders() {
  const responderName = document.getElementById('responderName').value.trim();
  const responderContact = document.getElementById('responderContact').value.trim();
  const notes = document.getElementById('responderNotes').value.trim();
  
  let assignedRespondersList = [];
  let assignedUnit = '';
  let contact = '';
  
  // Process selected default responders
  selectedResponders.forEach(id => {
    const responder = defaultRespondersData.find(r => r.id === id);
    if (responder) {
      assignedRespondersList.push(responder.name);
      if (!assignedUnit) {
        assignedUnit = responder.unit;
      }
    }
  });
  
  // Process custom responder
  if (responderName) {
    assignedRespondersList.push(responderName);
    contact = responderContact || '';
    if (!assignedUnit) {
      assignedUnit = 'Custom Unit';
    }
  }
  
  if (assignedRespondersList.length === 0) {
    alert('Please select at least one responder or add a custom responder.');
    return;
  }
  
  try {
    const assignedRespondersText = assignedRespondersList.join(', ');
    
    // Prepare update data for all three columns
    const updateData = {
      status: 'investigating',
      updated_at: new Date().toISOString(),
      assigned_responders: assignedRespondersText,
      assigned_unit: assignedUnit,
      contact: contact
    };
    
    // Add notes if available
    if (notes) {
      if (tableColumns.includes('responder_notes')) {
        updateData.responder_notes = notes;
      } else if (tableColumns.includes('notes')) {
        updateData.notes = notes;
      } else if (tableColumns.includes('description')) {
        updateData.description = notes;
      }
    }
    
    // Update the report in Supabase
    const { error } = await supabase
      .from('reports')
      .update(updateData)
      .eq('id', currentReportId);
    
    if (error) throw error;
    
    // Format display text
    let displayText = assignedRespondersText;
    if (assignedUnit) {
      displayText += ` (${assignedUnit})`;
    }
    if (contact) {
      displayText += ` - ${contact}`;
    }
    
    alert(`âœ… ${assignedRespondersList.length} responder(s) assigned successfully!\n\nAssigned: ${displayText}\nIncident: #${currentReportId.substring(0, 8)}`);
    
    // Update the card display
    const card = document.querySelector(`[data-report-id="${currentReportId}"]`);
    if (card) {
      const displayElement = document.querySelector(`#assignedRespondersDisplay-${currentReportId}`);
      if (displayElement) {
        displayElement.textContent = displayText;
      }
      
      card.dataset.assignedResponders = displayText;
      
      // Update action buttons
      const actionButtons = card.querySelector('.action-buttons');
      if (actionButtons) {
        actionButtons.innerHTML = `
          <button class="quick-route-btn" onclick="openQuickRouteModal('${currentReportId}', null, null, '${displayText.replace(/'/g, "\\'")}')">
            <i class="fas fa-route"></i> NAVIGATE TO INCIDENT
          </button>
          <button class="resolve-btn" onclick="openResolveModal('${currentReportId}')">
            <i class="fas fa-check-circle"></i> RESOLVE
          </button>
        `;
      }
      
      // Update status badge
      const statusBadge = card.querySelector('.status-badge');
      if (statusBadge) {
        statusBadge.className = 'status-badge status-investigating';
        statusBadge.textContent = 'Investigating';
      }
    }
    
    // Close modal and reset
    closeModal('respondersModal');
    selectedResponders = [];
    document.getElementById('responderName').value = '';
    document.getElementById('responderContact').value = '';
    document.getElementById('responderNotes').value = '';
    
    // Reload reports to show updated data
    setTimeout(() => {
      loadReports();
    }, 1000);
    
  } catch (error) {
    console.error('Error assigning responders:', error);
    alert('âŒ Error assigning responders. Please try again.');
  }
}

function openQuickRouteModal(reportId, latitude, longitude, assignedResponders = '') {
  currentReportId = reportId;
  
  // If coordinates aren't provided, we'll get them from the database
  if (!latitude || !longitude) {
    supabase
      .from('reports')
      .select('latitude, longitude')
      .eq('id', reportId)
      .single()
      .then(({ data, error }) => {
        if (data) {
          currentReportData = data;
          document.getElementById('routeDestination').textContent = `Coordinates: ${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
        }
      });
  } else {
    currentReportData = { latitude, longitude };
    document.getElementById('routeDestination').textContent = `Coordinates: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
  }
  
  if (assignedResponders) {
    assignedRespondersList = [assignedResponders];
  } else {
    const card = document.querySelector(`[data-report-id="${reportId}"]`);
    if (card && card.dataset.assignedResponders) {
      assignedRespondersList = [card.dataset.assignedResponders];
    }
  }
  
  const assignedUnitsText = assignedRespondersList.length > 0 
    ? assignedRespondersList.join(', ')
    : 'No responders assigned';
  
  document.getElementById('assignedUnits').textContent = assignedUnitsText;
  document.getElementById('routeStatus').textContent = 'Ready for route calculation';
  
  openModal('quickRouteModal');
}

function openResolveModal(reportId) {
  currentReportId = reportId;
  document.getElementById('resolveIncidentId').textContent = reportId ? '#' + reportId.substring(0, 12) : 'N/A';
  openModal('resolveModal');
}

async function resolveIncident() {
  const status = document.getElementById('resolutionStatus').value;
  const notes = document.getElementById('resolutionNotes').value.trim();
  
  if (!notes) {
    alert('Please enter resolution notes.');
    return;
  }
  
  try {
    const updateData = {
      status: 'resolved',
      updated_at: new Date().toISOString()
    };
    
    if (notes) {
      if (tableColumns.includes('description')) {
        updateData.description = notes + ' - Resolution status: ' + status;
      } else if (tableColumns.includes('notes')) {
        updateData.notes = notes + ' - Resolution status: ' + status;
      } else if (tableColumns.includes('resolution_notes')) {
        updateData.resolution_notes = notes;
      }
    }
    
    if (tableColumns.includes('resolution_status')) {
      updateData.resolution_status = status;
    }
    
    const { error } = await supabase
      .from('reports')
      .update(updateData)
      .eq('id', currentReportId);
    
    if (error) throw error;
    
    alert(`âœ… Incident marked as resolved!\n\nIncident: #${currentReportId.substring(0, 8)}`);
    
    closeModal('resolveModal');
    
    setTimeout(() => {
      loadReports();
    }, 500);
    
  } catch (error) {
    console.error('Error resolving incident:', error);
    alert('âŒ Error marking incident as resolved. Please try again.');
  }
}

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', async () => {
  await getUserLocation();
  await getTableColumns();
  loadReports();
  
  setInterval(loadReports, 30000);
  
  document.getElementById('confirmRespondersBtn').onclick = assignResponders;
  document.getElementById('confirmResolveBtn').onclick = resolveIncident;
});
</script>
</body>
</html>
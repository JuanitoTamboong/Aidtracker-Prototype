<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Fire Department Dashboard-AidTracker</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --primary-blue: #001f3f;
      --accent-gold: #ffd700;
      --light-gold: #fff8dc;
      --danger-red: #e74c3c;
      --warning-orange: #f39c12;
      --success-green: #2ecc71;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --header-height: 70px;
      --tab-bar-height: 60px;
      --sidebar-width: 0px; /* Start at 0 for mobile */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--primary-blue), #003366);
      background-attachment: fixed;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* === Glass Morphism Effect === */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
    }

    /* === Header === */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      z-index: 1000;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 31, 63, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--accent-gold);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      font-size: 20px;
      flex-shrink: 0;
    }

    .header-titles {
      min-width: 0;
      flex: 1;
    }

    .main-title {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .main-title span {
      color: var(--accent-gold);
    }

    .subtitle {
      font-size: 11px;
      color: var(--light-gold);
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--success-green);
      margin-left: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .notification-btn {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--accent-gold);
      font-size: 18px;
      flex-shrink: 0;
      text-decoration: none;
    }

    .notification-btn:hover {
      background: rgba(255, 215, 0, 0.1);
    }

    .notif-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background-color: var(--danger-red);
      border-radius: 50%;
      display: none;
    }

    /* === Desktop Navigation === */
    .desktop-nav {
      display: none; /* Hidden on mobile by default */
      position: fixed;
      left: 0;
      top: var(--header-height);
      bottom: 0;
      width: var(--sidebar-width);
      z-index: 900;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    .desktop-nav-btn {
      width: 100%;
      padding: 16px 0;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
    }

    .desktop-nav-btn i {
      font-size: 22px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .desktop-nav-btn:hover {
      color: var(--accent-gold);
      background: rgba(255, 215, 0, 0.1);
    }

    .desktop-nav-btn.active {
      color: var(--accent-gold);
      background: rgba(255, 215, 0, 0.15);
      border-left: 3px solid var(--accent-gold);
    }

    /* === Tab Navigation (Mobile) === */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--tab-bar-height);
      z-index: 1000;
      display: flex; /* Visible on mobile */
      padding: 8px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      gap: 8px;
      background: rgba(0, 31, 63, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 10px;
      padding: 8px 0;
      font-size: 11px;
      font-weight: 600;
    }

    .tab-btn i {
      font-size: 20px;
    }

    .tab-btn.active {
      color: var(--accent-gold);
      background: rgba(255, 215, 0, 0.1);
    }

    /* === Main Content === */
    .main-content {
      padding: calc(var(--header-height) + 16px) 16px calc(var(--tab-bar-height) + 16px);
      max-width: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .content-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === Map Section === */
    .map-section {
      height: 300px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
      position: relative;
      border: 2px solid var(--accent-gold);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #fullMap {
      width: 100%;
      height: 100%;
    }

    .map-controls {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .map-control {
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--accent-gold);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .map-control:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    /* === Stats Section === */
    .stats-section {
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-gold);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .stat-card {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      margin: 8px 0;
      color: #fff;
    }

    .stat-label {
      font-size: 12px;
      color: var(--light-gold);
      opacity: 0.9;
    }

    /* === Quick Filters === */
    .filter-section {
      margin-bottom: 16px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .filter-btn {
      padding: 12px 8px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .filter-btn i {
      font-size: 16px;
    }

    .filter-btn.active {
      background: var(--accent-gold);
      color: var(--primary-blue);
      border-color: var(--accent-gold);
    }

    /* === Reports Section === */
    .reports-section {
      margin-bottom: 16px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .refresh-btn {
      padding: 8px 16px;
      background: var(--accent-gold);
      color: var(--primary-blue);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      white-space: nowrap;
    }

    .refresh-btn:hover {
      background: #ffed4e;
      transform: translateY(-2px);
    }

    .refresh-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .reports-list {
      border-radius: 12px;
      overflow: hidden;
    }

    .report-item {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s;
    }

    .report-item:last-child {
      border-bottom: none;
    }

    .report-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .report-type {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .type-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .type-name {
      font-weight: 600;
      font-size: 14px;
    }

    .report-id {
      font-size: 12px;
      color: var(--light-gold);
      opacity: 0.7;
    }

    .report-details {
      margin-bottom: 12px;
    }

    .report-location {
      font-size: 13px;
      color: #fff;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .report-time {
      font-size: 11px;
      color: var(--light-gold);
      opacity: 0.7;
    }

    .report-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      min-width: 80px;
      text-align: center;
    }

    .status-pending {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
    }

    .status-investigating {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .status-assigned {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
    }

    .status-resolved {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }

    .photo-btn {
      padding: 6px 12px;
      background: var(--accent-gold);
      color: var(--primary-blue);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.3s;
    }

    .photo-btn:hover {
      background: #ffed4e;
      transform: translateY(-2px);
    }

    /* === Photo Modal === */
    .photo-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .modal-content {
      width: 100%;
      max-width: 500px;
      max-height: 90%;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid var(--accent-gold);
    }

    .modal-img {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
    }

    .modal-header {
      padding: 16px;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--accent-gold);
    }

    .modal-title {
      font-size: 16px;
      font-weight: bold;
      color: var(--accent-gold);
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--danger-red);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* === Connection Status === */
    .connection-status {
      position: fixed;
      top: calc(var(--header-height) + 16px);
      right: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .connection-connected {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .connection-disconnected {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    /* === Toast Notification === */
    .toast {
      position: fixed;
      bottom: calc(var(--tab-bar-height) + 16px);
      left: 16px;
      right: 16px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      border-left: 4px solid var(--accent-gold);
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === Empty State === */
    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: var(--light-gold);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      opacity: 0.7;
    }

    /* === Loading States === */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      flex-direction: column;
      gap: 16px;
      color: var(--light-gold);
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent-gold);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============================================
       DESKTOP RESPONSIVE DESIGN
       ============================================ */
    @media (min-width: 768px) {
      :root {
        --header-height: 80px;
        --tab-bar-height: 0px;
        --sidebar-width: 90px; /* Now sidebar appears */
      }

      /* HIDE mobile tab bar on desktop */
      .tab-bar {
        display: none !important;
      }

      /* SHOW desktop navigation on desktop */
      .desktop-nav {
        display: flex !important;
        flex-direction: column;
        align-items: center;
        background: rgba(0, 31, 63, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 215, 0, 0.2);
      }

      /* Adjust main content for sidebar */
      .main-content {
        padding: calc(var(--header-height) + 24px) 24px 24px calc(var(--sidebar-width) + 24px) !important;
        max-width: 100%;
      }

      .main-header {
        padding-left: calc(var(--sidebar-width) + 24px) !important;
        padding-right: 24px !important;
        background: rgba(0, 31, 63, 0.9);
      }

      .main-title {
        font-size: 22px;
      }

      .subtitle {
        font-size: 13px;
      }

      .live-badge {
        font-size: 11px;
      }

      /* Improve map sizing */
      .map-section {
        height: 400px;
        margin-bottom: 24px;
      }

      /* Dashboard grid layout */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .stats-section {
        margin-bottom: 0;
      }

      .filter-section {
        grid-column: 1 / -1;
        margin-bottom: 0;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .filters-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
      }

      .filter-btn {
        padding: 16px 12px;
        font-size: 13px;
      }

      .filter-btn i {
        font-size: 18px;
      }

      /* Reports section */
      .reports-section {
        margin-bottom: 0;
      }

      /* Toast positioning */
      .toast {
        left: auto;
        right: 24px;
        bottom: 24px;
        max-width: 400px;
      }

      /* Connection status positioning */
      .connection-status {
        top: calc(var(--header-height) + 24px);
        right: 24px;
      }

      /* Desktop nav button improvements */
      .desktop-nav-btn {
        padding: 18px 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
      }

      .desktop-nav-btn i {
        font-size: 24px;
        margin-bottom: 4px;
      }

      .desktop-nav-btn.active {
        color: var(--accent-gold);
        background: rgba(255, 215, 0, 0.2);
        border-left: 4px solid var(--accent-gold);
      }
    }

    /* Larger desktop screens */
    @media (min-width: 1024px) {
      :root {
        --sidebar-width: 100px;
      }

      .main-content {
        max-width: 1400px;
        margin: 0 auto;
        padding-left: calc(var(--sidebar-width) + 32px) !important;
        padding-right: 32px !important;
      }

      .main-header {
        padding-left: calc(var(--sidebar-width) + 32px) !important;
        padding-right: 32px !important;
      }

      .dashboard-grid {
        grid-template-columns: 3fr 1fr;
        gap: 32px;
      }

      .map-section {
        height: 500px;
      }

      .stat-card {
        padding: 20px;
      }

      .stat-value {
        font-size: 32px;
      }

      .stat-label {
        font-size: 14px;
      }

      .desktop-nav-btn {
        padding: 20px 0;
        font-size: 14px;
      }

      .desktop-nav-btn i {
        font-size: 26px;
      }
    }

    /* Extra large screens */
    @media (min-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 3fr 1fr;
      }
      
      .map-section {
        height: 550px;
      }
    }

    /* === iPhone Notch & Safe Area Support === */
    @supports (padding: max(0px)) {
      .main-header {
        padding-left: max(16px, env(safe-area-inset-left)) !important;
        padding-right: max(16px, env(safe-area-inset-right)) !important;
        padding-top: env(safe-area-inset-top);
        height: calc(var(--header-height) + env(safe-area-inset-top));
      }

      .tab-bar {
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
        padding-bottom: env(safe-area-inset-bottom);
        height: calc(var(--tab-bar-height) + env(safe-area-inset-bottom));
      }

      .main-content {
        padding-left: max(16px, env(safe-area-inset-left)) !important;
        padding-right: max(16px, env(safe-area-inset-right)) !important;
      }
      
      @media (min-width: 768px) {
        .main-header {
          padding-left: calc(var(--sidebar-width) + max(24px, env(safe-area-inset-left))) !important;
        }
        
        .main-content {
          padding-left: calc(var(--sidebar-width) + max(24px, env(safe-area-inset-left))) !important;
        }
        
        .desktop-nav {
          padding-top: calc(20px + env(safe-area-inset-top));
        }
      }
    }

    /* === High Contrast Mode Support === */
    @media (prefers-contrast: high) {
      .glass {
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid white;
      }

      .stat-card {
        border: 1px solid white;
      }
      
      .desktop-nav-btn {
        color: white;
      }
      
      .desktop-nav-btn.active {
        color: var(--accent-gold);
        background: rgba(255, 215, 0, 0.3);
      }
    }

    /* === Reduced Motion Support === */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <!-- Photo Modal -->
  <div id="photoModal" class="photo-modal">
    <div class="modal-content glass">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Incident Photo</div>
        <button class="modal-close" onclick="closePhotoModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <img id="modalImage" class="modal-img" src="" alt="Incident Photo" loading="lazy">
    </div>
  </div>

  <!-- Connection Status Indicator -->
  <div id="connectionStatus" class="connection-status" style="display: none;">
    <i class="fas fa-circle"></i>
    <span>Connected</span>
  </div>

  <!-- Desktop Navigation Sidebar -->
  <nav class="desktop-nav glass">
    <button class="desktop-nav-btn active" onclick="switchTab('overview')" data-tab="overview">
      <i class="fas fa-home"></i>
      <span>Overview</span>
    </button>
    <button class="desktop-nav-btn" onclick="switchTab('map')" data-tab="map">
      <i class="fas fa-map"></i>
      <span>Map</span>
    </button>
    <button class="desktop-nav-btn" onclick="switchTab('reports')" data-tab="reports">
      <i class="fas fa-list"></i>
      <span>Cases</span>
    </button>
    <div style="flex: 1;"></div>
    <button class="desktop-nav-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </button>
  </nav>

  <!-- Main Header -->
  <header class="main-header glass">
    <div class="header-left">
      <div class="logo-icon">
        <i class="fas fa-fire"></i>
      </div>
      <div class="header-titles">
        <div class="main-title">Fire<span>Department</span>
          <span class="live-badge">
            <i class="fas fa-broadcast-tower"></i> LIVE
          </span>
        </div>
        <div class="subtitle">Emergency Fire Response Dashboard</div>
      </div>
    </div>

    <div class="header-actions">
    <a href="/fire-notif" class="notification-btn glass" title="Notifications">
        <i class="fas fa-bell"></i>
        <span class="notif-dot" id="notifDot"></span>
    </a>
</div>
  </header>

  <!-- Tab Navigation (Mobile) -->
  <nav class="tab-bar glass">
    <button class="tab-btn active" onclick="switchTab('overview')">
      <i class="fas fa-home"></i>
      <span>Overview</span>
    </button>
    <button class="tab-btn" onclick="switchTab('map')">
      <i class="fas fa-map"></i>
      <span>Map</span>
    </button>
    <button class="tab-btn" onclick="switchTab('reports')">
      <i class="fas fa-list"></i>
      <span>Cases</span>
    </button>
    <button class="tab-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </button>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Overview Tab -->
    <section id="overviewTab" class="content-section active">
      <!-- Dashboard Grid for Desktop -->
      <div class="dashboard-grid">
        <!-- Map Section -->
        <div class="map-section glass">
          <div class="map-controls">
            <button class="map-control" onclick="fitAllMarkers()">
              <i class="fas fa-expand"></i> Show All
            </button>
            <button class="map-control" onclick="clearFilters()">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
          <div id="map"></div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-section">
          <h2 class="section-title">
            <i class="fas fa-chart-bar"></i> Fire Incident Overview
          </h2>
          <div class="stats-grid">
            <div class="stat-card glass">
              <div class="stat-value" id="totalIncidents">0</div>
              <div class="stat-label">Total Fire Cases</div>
            </div>
            <div class="stat-card glass">
              <div class="stat-value" id="pendingIncidents">0</div>
              <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card glass">
              <div class="stat-value" id="assignedIncidents">0</div>
              <div class="stat-label">Assigned</div>
            </div>
            <div class="stat-card glass">
              <div class="stat-value" id="resolvedIncidents">0</div>
              <div class="stat-label">Resolved</div>
            </div>
          </div>
        </div>

        <!-- Quick Filters -->
        <div class="filter-section">
          <h2 class="section-title">
            <i class="fas fa-filter"></i> Quick Filters
          </h2>
          <div class="filters-grid">
            <button class="filter-btn active" onclick="filterByType('all', this)">
              <i class="fas fa-layer-group"></i>
              <span>All</span>
            </button>
            <button class="filter-btn" onclick="filterByType('fire_accident', this)">
              <i class="fas fa-fire"></i>
              <span>Fire Accidents</span>
            </button>
            <button class="filter-btn" onclick="filterByStatus('pending', this)">
              <i class="fas fa-clock"></i>
              <span>Pending</span>
            </button>
            <button class="filter-btn" onclick="filterByStatus('investigating', this)">
              <i class="fas fa-search"></i>
              <span>Investigating</span>
            </button>
            <button class="filter-btn" onclick="filterByStatus('resolved', this)">
              <i class="fas fa-check"></i>
              <span>Resolved</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Recent Reports -->
      <div class="reports-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-list-alt"></i> Recent Fire Cases
          </h2>
          <button class="refresh-btn" onclick="manualRefresh()" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        <div class="reports-list glass" id="recentReportsList">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Loading fire cases...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Map Tab -->
    <section id="mapTab" class="content-section">
      <div class="map-section glass" style="height: calc(100vh - var(--header-height) - 48px);">
        <div class="map-controls">
          <button class="map-control" onclick="fitAllMarkers()">
            <i class="fas fa-expand"></i> Show All
          </button>
          <button class="map-control" onclick="clearFilters()">
            <i class="fas fa-times"></i> Clear
          </button>
          <button class="map-control" onclick="manualRefresh()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        <div id="fullMap"></div>
      </div>
    </section>

    <!-- Reports Tab -->
    <section id="reportsTab" class="content-section">
      <div class="reports-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-clipboard-list"></i> All Fire Cases
            <span id="tableFilterInfo" style="font-size: 12px; color: var(--light-gold); margin-left: 8px;"></span>
          </h2>
          <button class="refresh-btn" onclick="manualRefresh()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        <div class="reports-list glass" id="allReportsList">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Loading all fire cases...</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>

    // ============ CONFIGURATION ============
    const SUPABASE_URL = 'https://gwvepxupoxyyydnisulb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3dmVweHVwb3h5eXlkbmlzdWxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDE4ODcsImV4cCI6MjA4MDM3Nzg4N30.Ku9SXTAKNMvHilgEpxj5HcVA-0TPt4ziuEq0Irao5Qc';
    const OPENCAGE_API_KEY = '0a78fbd8bcd74be398f210b34682c77c';

    // ============ GLOBAL VARIABLES ============
    let supabaseClient = null;
    let map = null;
    let fullMap = null;
    let markers = [];
    let allReports = [];
    let filteredReports = [];
    let currentFilter = { type: 'all', status: 'all' };
    let realtimeSubscription = null;
    let addressCache = new Map();
    let isInitialLoad = true;
    let touchStartX = 0;
    let touchEndX = 0;
    let currentTab = 'overview'; // Track current tab

    // Incident Type Configuration
    const typeConfig = {
      fire_accident: {
        name: 'Fire Accident',
        icon: 'fire',
        color: '#ffd700'  // Using the same gold color as police theme
      },
      default: {
        name: 'Incident',
        icon: 'fire',
        color: '#ffd700'  // Using the same gold color as police theme
      }
    };

    // ============ INITIALIZATION ============
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üî• Fire Department Dashboard Initializing...');
      
      // Initialize Supabase
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      
      // Check authentication
      if (!checkAuthentication()) return;
      
      // Initialize maps
      initializeMaps();
      
      // Setup event listeners
      setupEventListeners();
      
      // Load initial data
      await loadInitialData();
      
      // Setup realtime subscription
      setupRealtimeSubscription();
      
      // Make functions globally available
      exposeGlobalFunctions();
    });

    // ============ AUTHENTICATION ============
    function checkAuthentication() {
      try {
        const user = localStorage.getItem('user');
        if (!user) {
          window.location.href = 'index.html';
          return false;
        }

        const userData = JSON.parse(user);
        
        // Check for fire department access
        if (userData.station === 'fire' || 
            userData.email === 'fireadmin@gmail.com' || 
            userData.role === 'admin') {
          console.log('‚úÖ User authenticated for fire department dashboard');
          return true;
        }
        
        alert('‚ö†Ô∏è Access denied. Fire department dashboard only.');
        window.location.href = 'index.html';
        return false;
        
      } catch (error) {
        console.error('Auth error:', error);
        window.location.href = 'index.html';
        return false;
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('user');
        if (realtimeSubscription) {
          supabaseClient.removeChannel(realtimeSubscription);
        }
        window.location.href = 'index.html';
      }
    }

    // ============ MAP FUNCTIONS ============
    function initializeMaps() {
      // Main overview map
      map = L.map("map").setView([12.4048, 121.9829], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap"
      }).addTo(map);

      // Full screen map
      fullMap = L.map("fullMap").setView([12.4048, 121.9829], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap"
      }).addTo(fullMap);

      console.log('üó∫Ô∏è Maps initialized');
    }

    function createCustomIcon(type, status = 'pending') {
      const config = typeConfig[type] || typeConfig.default;
      
      // Adjust color based on status
      let statusColor = config.color;
      if (status === 'pending') statusColor = '#f39c12';
      if (status === 'resolved') statusColor = '#2ecc71';
      if (status === 'investigating') statusColor = '#e74c3c';
      if (status === 'assigned') statusColor = '#3498db';
      
      return L.divIcon({
        html: `
          <div style="
            background-color: ${statusColor};
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
          ">
            <i class="fas fa-${config.icon}"></i>
          </div>
        `,
        className: 'custom-marker',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
    }

    function clearMarkers() {
      console.log('üóëÔ∏è Clearing markers...');
      markers.forEach(marker => {
        // Remove from both maps to be safe
        if (map) map.removeLayer(marker);
        if (fullMap) fullMap.removeLayer(marker);
      });
      markers = [];
      console.log('‚úÖ Markers cleared');
    }

    function addReportMarker(report, targetMap = null) {
      if (!report.latitude || !report.longitude) {
        console.warn('‚ö†Ô∏è No coordinates for report:', report.id);
        return null;
      }

      try {
        const icon = createCustomIcon(report.type, report.status);
        const marker = L.marker([report.latitude, report.longitude], { icon });
        
        // Determine which map to add to based on current tab
        let target = targetMap;
        if (!target) {
          if (currentTab === 'overview') {
            target = 'overview';
          } else if (currentTab === 'map') {
            target = 'full';
          }
        }
        
        if (target === 'overview' || target === 'both') {
          if (map) {
            marker.addTo(map);
            console.log(`üìç Added marker to overview map for report #${report.id}`);
          }
        }
        if (target === 'full' || target === 'both') {
          if (fullMap) {
            marker.addTo(fullMap);
            console.log(`üìç Added marker to full map for report #${report.id}`);
          }
        }

        // Create popup content
        const popupContent = createPopupContent(report);
        marker.bindPopup(popupContent);
        
        markers.push(marker);
        return marker;
      } catch (error) {
        console.error('Error adding marker:', error, report);
        return null;
      }
    }

    function createPopupContent(report) {
      const photoUrl = getPhotoUrl(report);
      const statusColor = getStatusColor(report.status);
      const shortLocation = report.location.length > 50 ? 
        report.location.substring(0, 50) + '...' : report.location;
      
      return `
        <div style="min-width: 250px; max-width: 300px; padding: 10px; font-family: -apple-system, sans-serif;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${typeConfig[report.type]?.color || typeConfig.default.color};"></div>
            <strong style="color: #333; font-size: 14px;">${typeConfig[report.type]?.name || typeConfig.default.name}</strong>
            <span style="margin-left: auto; font-size: 11px; color: #666; font-weight: bold;">#${report.id}</span>
          </div>
          
          <div style="margin-bottom: 8px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">Location</div>
            <div style="font-size: 13px; color: #222;">${shortLocation}</div>
          </div>
          
          <div style="margin-bottom: 8px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">Status</div>
            <span style="
              display: inline-block;
              padding: 4px 10px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: bold;
              background: ${statusColor.bg};
              color: ${statusColor.text};
            ">
              ${report.status.charAt(0).toUpperCase() + report.status.slice(1)}
            </span>
          </div>
          
          <div style="font-size: 11px; color: #666; margin-top: 10px;">
            <i class="fas fa-clock"></i> ${formatDateTime(report.created_at)}
          </div>
          
          ${photoUrl ? `
            <div style="margin-top: 12px;">
              <button onclick="window.showPhotoModal('${photoUrl}', 'Report #${report.id}')"
                style="
                  width: 100%;
                  padding: 8px;
                  background: ${typeConfig[report.type]?.color || typeConfig.default.color};
                  color: var(--primary-blue);
                  border: none;
                  border-radius: 6px;
                  font-size: 12px;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 6px;
                ">
                <i class="fas fa-camera"></i> View Photo
              </button>
            </div>
          ` : ''}
        </div>
      `;
    }

    function getStatusColor(status) {
      switch(status) {
        case 'pending': return { bg: '#fff3cd', text: '#856404' };
        case 'investigating': return { bg: '#d1ecf1', text: '#0c5460' };
        case 'assigned': return { bg: '#cce5ff', text: '#004085' };
        case 'resolved': return { bg: '#d4edda', text: '#155724' };
        default: return { bg: '#f8d7da', text: '#721c24' };
      }
    }

    function fitAllMarkers() {
      console.log('üîç Fitting all markers to view...');
      
      // Determine which map is currently active based on currentTab
      let currentMap;
      if (currentTab === 'overview') {
        currentMap = map;
      } else if (currentTab === 'map') {
        currentMap = fullMap;
      } else {
        console.error('‚ùå No active tab found for map');
        showToast('Map not available', 'error');
        return;
      }
      
      if (!currentMap) {
        console.error('‚ùå Map not initialized');
        showToast('Map not available', 'error');
        return;
      }
      
      // Get markers that are on the current map
      const validMarkers = markers.filter(m => {
        const latLng = m.getLatLng();
        return latLng && m._map === currentMap;
      });
      
      console.log(`üìç Found ${validMarkers.length} valid markers on current map`);
      
      if (validMarkers.length > 0) {
        const group = L.featureGroup(validMarkers);
        currentMap.fitBounds(group.getBounds().pad(0.1));
        showToast(`Showing ${validMarkers.length} fire incidents on map`, 'success');
      } else {
        console.warn('‚ö†Ô∏è No markers to display');
        showToast('No fire incidents to display on map', 'warning');
      }
    }

    // ============ DATA FUNCTIONS ============
    async function getReadableAddress(lat, lng) {
      const cacheKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      if (addressCache.has(cacheKey)) {
        return addressCache.get(cacheKey);
      }

      try {
        const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${OPENCAGE_API_KEY}&language=en&limit=1`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Geocoding API error');
        
        const data = await response.json();
        
        if (data.results?.[0]?.formatted) {
          const address = data.results[0].formatted;
          addressCache.set(cacheKey, address);
          return address;
        }
        return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      } catch (error) {
        console.error('Geocoding error:', error);
        return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      }
    }

    function getPhotoUrl(report) {
      // Check photo_url field first
      if (report.photo_url && report.photo_url.trim() && report.photo_url !== 'null') {
        return report.photo_url.trim();
      }
      
      // Check photo field (could be base64 or path)
      if (report.photo && report.photo.trim() && report.photo !== 'null') {
        // If it's a base64 image
        if (report.photo.startsWith('data:image')) {
          return report.photo;
        }
        
        // If it's a Supabase storage path
        if (report.photo.startsWith('incident_photos/')) {
          const { data } = supabaseClient.storage
            .from('incident_photos')
            .getPublicUrl(report.photo);
          return data?.publicUrl || null;
        }
        
        // Assume it's a direct URL
        return report.photo;
      }
      
      // Check image_url field
      if (report.image_url && report.image_url.trim() && report.image_url !== 'null') {
        return report.image_url.trim();
      }
      
      return null;
    }

    async function processReport(rawReport) {
      try {
        // Determine incident type - process only fire-related incidents
        let incidentType = '';
        const dbType = (rawReport.type || '').toString().toLowerCase().trim();

        // Process only fire emergencies
        if (dbType.includes('fire') || dbType.includes('blaze') || dbType.includes('flame') ||
            dbType.includes('burn') || dbType.includes('inferno') || dbType.includes('combust')) {
          incidentType = 'fire_accident';
        } else {
          // Skip non-fire incidents
          console.log('Skipping non-fire incident:', dbType);
          return null;
        }

        // Get location coordinates
        const lat = parseFloat(rawReport.latitude);
        const lng = parseFloat(rawReport.longitude);
        let location = 'Location not specified';

        if (!isNaN(lat) && !isNaN(lng)) {
          location = await getReadableAddress(lat, lng);
        } else if (rawReport.location_name && rawReport.location_name.trim()) {
          location = rawReport.location_name.trim();
        } else if (rawReport.location && rawReport.location.trim()) {
          location = rawReport.location.trim();
        }

        // Get reporter name
        const reporterName = rawReport.reporter ||
                           rawReport.reporter_name ||
                           rawReport.name ||
                           rawReport.reporter_email ||
                           'Anonymous';

        // Get photo URL
        const photoUrl = getPhotoUrl(rawReport);

        // Parse timestamp
        const createdAt = rawReport.created_at ||
                         rawReport.reported_at ||
                         rawReport.timestamp ||
                         new Date().toISOString();

        // Determine status
        const status = (rawReport.status || 'pending').toLowerCase();

        return {
          id: rawReport.id,
          type: incidentType,
          location: location,
          reporter_name: reporterName,
          created_at: createdAt,
          status: status,
          latitude: isNaN(lat) ? 12.4048 : lat,
          longitude: isNaN(lng) ? 121.9829 : lng,
          description: rawReport.description || rawReport.details || rawReport.incident_details || '',
          photo_url: photoUrl,
          photo: rawReport.photo || rawReport.photo_url || rawReport.image_url || null,
          original_data: rawReport
        };
      } catch (error) {
        console.error('Error processing report:', error, rawReport);
        return null;
      }
    }

    async function loadInitialData() {
      const refreshBtn = document.getElementById('refreshBtn');
      const originalHTML = refreshBtn.innerHTML;
      
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
      refreshBtn.disabled = true;

      try {
        console.log('üì• Loading initial data...');
        
        const { data, error } = await supabaseClient
          .from('reports')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }

        console.log(`üìä Retrieved ${data?.length || 0} raw reports`);

        // Process all reports
        const reportPromises = (data || []).map(processReport);
        const processedReports = await Promise.all(reportPromises);
        
        // Filter out null reports (non-fire incidents)
        allReports = processedReports.filter(report => report !== null);
        
        console.log(`üî• Filtered to ${allReports.length} fire cases`);

        // Apply filters and update UI
        applyFilters();
        updateStatistics();
        updateRecentReports();
        updateAllReports();
        
        if (allReports.length > 0) {
          showToast(`Loaded ${allReports.length} fire cases`, 'success');
        } else {
          showToast('No fire cases found in database', 'info');
        }

      } catch (error) {
        console.error('Error loading reports:', error);
        showToast(`Error loading data: ${error.message}`, 'error');
        
        // Show empty state
        document.getElementById('recentReportsList').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Unable to Load Data</h3>
            <p>Please check your connection and try again</p>
            <button class="refresh-btn" onclick="manualRefresh()" style="margin-top: 16px;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
        
        document.getElementById('allReportsList').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Unable to Load Data</h3>
            <p>Please check your connection and try again</p>
          </div>
        `;

      } finally {
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
        isInitialLoad = false;
      }
    }

    // ============ FILTER FUNCTIONS ============
    function applyFilters() {
      console.log('üîç Applying filters:', currentFilter, 'on tab:', currentTab);
      
      // Clear existing markers
      clearMarkers();
      
      // Filter reports based on current filter
      filteredReports = allReports.filter(report => {
        // Type filter
        if (currentFilter.type !== 'all' && report.type !== currentFilter.type) {
          return false;
        }
        // Status filter
        if (currentFilter.status !== 'all' && report.status !== currentFilter.status) {
          return false;
        }
        return true;
      });
      
      console.log(`üìã Filtered to ${filteredReports.length} reports`);
      
      // Add markers for filtered reports based on current tab
      filteredReports.forEach(report => {
        addReportMarker(report);
      });
      
      // Update UI components
      updateRecentReports();
      updateAllReports();
      updateStatistics();
      updateFilterInfo();
      
      // Auto-fit map if we have markers and it's not initial load
      if (filteredReports.length > 0 && !isInitialLoad && (currentTab === 'overview' || currentTab === 'map')) {
        setTimeout(() => {
          fitAllMarkers();
        }, 100);
      }
    }

    function filterByType(type, buttonElement) {
      if (buttonElement) {
        // Update button states
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');
      }
      
      currentFilter.type = type;
      currentFilter.status = 'all'; // Reset status filter when type changes
      
      applyFilters();
      
      if (type !== 'all') {
        showToast(`Showing ${typeConfig[type]?.name || type} cases`, 'info');
      }
    }

    function filterByStatus(status, buttonElement) {
      if (buttonElement) {
        // Update button states
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');
      }
      
      currentFilter.status = status;
      currentFilter.type = 'all'; // Reset type filter when status changes
      
      applyFilters();
      
      if (status !== 'all') {
        showToast(`Showing ${status} cases`, 'info');
      }
    }

    function clearFilters() {
      currentFilter = { type: 'all', status: 'all' };
      
      // Reset filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('.filter-btn[onclick*="filterByType(\'all\'"]').classList.add('active');
      
      applyFilters();
      showToast('All filters cleared', 'info');
    }

    // ============ UI UPDATE FUNCTIONS ============
    function updateStatistics() {
      const total = allReports.length;
      const pending = allReports.filter(r => r.status === 'pending').length;
      const assigned = allReports.filter(r => r.status === 'assigned' || r.status === 'investigating').length;
      const resolved = allReports.filter(r => r.status === 'resolved').length;

      document.getElementById('totalIncidents').textContent = total;
      document.getElementById('pendingIncidents').textContent = pending;
      document.getElementById('assignedIncidents').textContent = assigned;
      document.getElementById('resolvedIncidents').textContent = resolved;

      // Update notification dot
      const notifDot = document.getElementById('notifDot');
      if (pending > 0) {
        notifDot.style.display = 'block';
      } else {
        notifDot.style.display = 'none';
      }
    }

    function updateRecentReports() {
      const container = document.getElementById('recentReportsList');
      const recentReports = filteredReports.slice(0, 5); // Show only 5 most recent
      
      if (recentReports.length === 0) {
        container.innerHTML = createEmptyState(
          allReports.length === 0 ? 
            'No fire cases in database yet' : 
            'No cases match current filters'
        );
        return;
      }
      
      container.innerHTML = recentReports.map(report => createReportCard(report)).join('');
    }

    function updateAllReports() {
      const container = document.getElementById('allReportsList');
      
      if (filteredReports.length === 0) {
        container.innerHTML = createEmptyState(
          allReports.length === 0 ? 
            'No fire cases in database yet' : 
            'No cases match current filters'
        );
        return;
      }
      
      container.innerHTML = filteredReports.map(report => createReportCard(report)).join('');
    }

    function createReportCard(report) {
      const photoUrl = getPhotoUrl(report);
      const statusClass = `status-${report.status}`;
      const time = new Date(report.created_at);
      const timeString = formatTime(time);
      const dateString = formatDate(time);
      
      return `
        <div class="report-item" data-report-id="${report.id}">
          <div class="report-header">
            <div class="report-type">
              <div class="type-indicator" style="background-color: ${typeConfig[report.type]?.color || typeConfig.default.color}"></div>
              <div class="type-name">${typeConfig[report.type]?.name || 'Fire Incident'}</div>
            </div>
            <div class="report-id">#${report.id}</div>
          </div>
          
          <div class="report-details">
            <div class="report-location" title="${report.location}">
              <i class="fas fa-map-marker-alt"></i>
              ${truncateText(report.location, 40)}
            </div>
            <div class="report-time">
              <i class="fas fa-clock"></i>
              ${timeString} ‚Ä¢ ${dateString}
            </div>
          </div>
          
          <div class="report-footer">
            <span class="status-badge ${statusClass}">
              ${report.status.charAt(0).toUpperCase() + report.status.slice(1)}
            </span>
            
            ${photoUrl ? `
              <button class="photo-btn" onclick="showPhotoModal('${photoUrl}', 'Report #${report.id}')">
                <i class="fas fa-camera"></i> Photo
              </button>
            ` : `
              <span style="color: #95a5a6; font-size: 11px;">No photo</span>
            `}
          </div>
        </div>
      `;
    }

    function createEmptyState(message) {
      return `
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h3>No Fire Cases Found</h3>
          <p>${message}</p>
          ${allReports.length === 0 ? '' : `
            <button class="filter-btn" onclick="clearFilters()" style="margin-top: 12px;">
              <i class="fas fa-times"></i> Clear Filters
            </button>
          `}
        </div>
      `;
    }

    function updateFilterInfo() {
      const filterInfo = document.getElementById('tableFilterInfo');
      const activeFilters = [];
      
      if (currentFilter.type !== 'all') {
        activeFilters.push(typeConfig[currentFilter.type]?.name || currentFilter.type);
      }
      if (currentFilter.status !== 'all') {
        activeFilters.push(currentFilter.status.charAt(0).toUpperCase() + currentFilter.status.slice(1));
      }
      
      filterInfo.textContent = activeFilters.length > 0 ? `(${activeFilters.join(' ‚Ä¢ ')})` : '';
    }

    // ============ REALTIME FUNCTIONS ============
    function setupRealtimeSubscription() {
      console.log('üì° Setting up realtime subscription...');
      
      if (realtimeSubscription) {
        supabaseClient.removeChannel(realtimeSubscription);
      }

      realtimeSubscription = supabaseClient
        .channel('reports-realtime')
        .on('postgres_changes', 
          { 
            event: '*', 
            schema: 'public', 
            table: 'reports' 
          }, 
          async (payload) => {
            console.log('üì® Realtime update:', payload.eventType, payload.new?.id);
            
            try {
              if (payload.eventType === 'INSERT') {
                const processed = await processReport(payload.new);
                if (processed) {
                  allReports.unshift(processed);
                  applyFilters();
                  showToast(`New ${typeConfig[processed.type]?.name || 'fire case'} reported`, 'info');
                  highlightNewReport(processed.id);
                }
              } else if (payload.eventType === 'UPDATE') {
                const processed = await processReport(payload.new);
                if (processed) {
                  const index = allReports.findIndex(r => r.id === processed.id);
                  if (index >= 0) {
                    allReports[index] = processed;
                  } else {
                    allReports.unshift(processed); // Add if not found
                  }
                  applyFilters();
                }
              } else if (payload.eventType === 'DELETE') {
                const index = allReports.findIndex(r => r.id === payload.old.id);
                if (index >= 0) {
                  allReports.splice(index, 1);
                  applyFilters();
                }
              }
              
              updateConnectionStatus(true);
            } catch (error) {
              console.error('Error processing realtime update:', error);
            }
          }
        )
        .subscribe((status) => {
          console.log('üì° Realtime subscription status:', status);
          
          if (status === 'SUBSCRIBED') {
            updateConnectionStatus(true);
          } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
            updateConnectionStatus(false);
            // Attempt to reconnect after 5 seconds
            setTimeout(() => {
              if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
                setupRealtimeSubscription();
              }
            }, 5000);
          }
        });
    }

    function highlightNewReport(reportId) {
      const items = document.querySelectorAll(`[data-report-id="${reportId}"]`);
      items.forEach(item => {
        item.style.animation = 'none';
        setTimeout(() => {
          item.style.animation = 'pulse 1s 2';
        }, 10);
      });
    }

    // ============ UTILITY FUNCTIONS ============
    function switchTab(tabName) {
      console.log('üîÑ Switching to tab:', tabName);
      
      // Update currentTab variable
      currentTab = tabName;
      
      // Update mobile tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll(`.tab-btn[onclick*="${tabName}"]`).forEach(btn => btn.classList.add('active'));
      
      // Update desktop nav buttons
      document.querySelectorAll('.desktop-nav-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll(`.desktop-nav-btn[data-tab="${tabName}"]`).forEach(btn => btn.classList.add('active'));
      
      // Show selected tab content
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${tabName}Tab`).classList.add('active');
      
      // Clear and re-add markers for the current tab
      applyFilters();
      
      // Refresh map if needed
      setTimeout(() => {
        if (tabName === 'map' && fullMap) {
          fullMap.invalidateSize();
          if (filteredReports.length > 0) {
            fitAllMarkers();
          }
        } else if (tabName === 'overview' && map) {
          map.invalidateSize();
          if (filteredReports.length > 0) {
            fitAllMarkers();
          }
        }
      }, 100);
    }

    async function manualRefresh() {
      console.log('üîÑ Manual refresh triggered');
      const btn = document.getElementById('refreshBtn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;
      
      try {
        // Reload data from database
        const { data, error } = await supabaseClient
          .from('reports')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        // Process all reports
        const reportPromises = (data || []).map(processReport);
        const processedReports = await Promise.all(reportPromises);
        
        // Filter out null reports
        allReports = processedReports.filter(report => report !== null);
        
        // Re-apply filters
        applyFilters();
        
        showToast(`Refreshed ${allReports.length} fire cases`, 'success');
        
      } catch (error) {
        console.error('Refresh error:', error);
        showToast('Refresh failed: ' + error.message, 'error');
        
      } finally {
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }, 1000);
      }
    }

    function showPhotoModal(imageUrl, title = 'Incident Photo') {
      if (imageUrl && imageUrl !== 'null' && imageUrl !== 'undefined') {
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageUrl;
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('photoModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      } else {
        showToast('No photo available for this incident', 'warning');
      }
    }

    function closePhotoModal() {
      document.getElementById('photoModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      // Clear the image source
      document.getElementById('modalImage').src = '';
    }

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (connected) {
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Realtime Connected';
        statusEl.className = 'connection-status connection-connected';
        statusEl.style.display = 'flex';
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      } else {
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Connection Lost';
        statusEl.className = 'connection-status connection-disconnected';
        statusEl.style.display = 'flex';
      }
    }

    function showToast(message, type = 'info') {
      // Remove existing toasts
      document.querySelectorAll('.toast').forEach(toast => toast.remove());
      
      const colors = {
        info: 'var(--accent-gold)',
        success: 'var(--success-green)',
        error: 'var(--danger-red)',
        warning: 'var(--warning-orange)'
      };
      
      const icons = {
        info: 'info-circle',
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle'
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast glass';
      toast.innerHTML = `
        <i class="fas fa-${icons[type]}" style="color: ${colors[type]};"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(date) {
      return date.toLocaleDateString();
    }

    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    // ============ EVENT LISTENERS ============
    function setupEventListeners() {
      console.log('üéØ Setting up event listeners...');
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          manualRefresh();
        }
        if (e.key === 'Escape') {
          closePhotoModal();
        }
        // Tab switching with arrow keys
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
          const tabs = ['overview', 'map', 'reports'];
          const currentIndex = tabs.indexOf(currentTab);
          if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
            switchTab(tabs[currentIndex + 1]);
          } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
            switchTab(tabs[currentIndex - 1]);
          }
        }
      });
      
      // Page visibility
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && !realtimeSubscription) {
          console.log('üîÅ Page visible, reconnecting...');
          setupRealtimeSubscription();
        }
      });
      
      // Swipe gestures for mobile tabs
      document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      });
      
      document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });
      
      function handleSwipe() {
        const swipeThreshold = 50;
        const swipeDistance = touchEndX - touchStartX;
        
        if (Math.abs(swipeDistance) > swipeThreshold) {
          const tabs = ['overview', 'map', 'reports'];
          const currentIndex = tabs.indexOf(currentTab);
          
          if (swipeDistance > 0 && currentIndex > 0) {
            // Swipe right - go to previous tab
            switchTab(tabs[currentIndex - 1]);
          } else if (swipeDistance < 0 && currentIndex < tabs.length - 1) {
            // Swipe left - go to next tab
            switchTab(tabs[currentIndex + 1]);
          }
        }
      }
      
      // Handle window resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (map) map.invalidateSize();
          if (fullMap) fullMap.invalidateSize();
          // Re-apply filters to ensure markers are on correct map
          applyFilters();
        }, 250);
      });
    }

    // ============ GLOBAL FUNCTION EXPOSURE ============
    function exposeGlobalFunctions() {
      window.showPhotoModal = showPhotoModal;
      window.closePhotoModal = closePhotoModal;
      window.filterByType = filterByType;
      window.filterByStatus = filterByStatus;
      window.clearFilters = clearFilters;
      window.fitAllMarkers = fitAllMarkers;
      window.manualRefresh = manualRefresh;
      window.switchTab = switchTab;
      window.logout = logout;
    }

    // ============ CLEANUP ============
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Cleaning up...');
      if (realtimeSubscription) {
        supabaseClient.removeChannel(realtimeSubscription);
      }
    });

    // Initialize on load
    console.log('‚úÖ Fire Department Dashboard ready');
  </script>
</body>
</html>
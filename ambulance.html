<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ambulance Station Dashboard - AidTracker</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --primary-blue: #001f3f;
      --accent-gold: #ffd700;
      --light-gold: #fff8dc;
      --danger-red: #e74c3c;
      --warning-orange: #f39c12;
      --success-green: #2ecc71;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--primary-blue), #003366);
      background-attachment: fixed;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px;
    }

    /* === Glass Morphism Effect === */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    /* === Header === */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px 15px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }

    .logo-icon {
      font-size: 28px;
      color: var(--accent-gold);
      flex-shrink: 0;
    }

    .logo-text {
      min-width: 0;
      overflow: hidden;
    }

    .title {
      font-size: 22px;
      font-weight: 800;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .title span {
      color: var(--accent-gold);
    }

    .subtitle {
      font-size: 11px;
      color: var(--light-gold);
      opacity: 0.9;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .realtime-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--success-green);
      margin-left: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .controls-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .logout-btn {
      background: var(--danger-red);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }

    .logout-btn:hover {
      background: #ff6b6b;
      transform: translateY(-2px);
    }

    .notification-btn {
      position: relative;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--accent-gold);
      font-size: 18px;
      flex-shrink: 0;
    }

    .notification-btn:hover {
      background: rgba(255, 215, 0, 0.1);
      transform: translateY(-2px);
    }

    .notif-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background-color: var(--danger-red);
      border-radius: 50%;
      display: none;
    }

    /* === Type Filter Buttons === */
    .type-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .type-btn {
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
      justify-content: center;
    }

    .type-btn:hover {
      background: rgba(255, 215, 0, 0.1);
      transform: translateY(-2px);
    }

    .type-btn.active {
      background: var(--accent-gold);
      color: var(--primary-blue);
      border-color: var(--accent-gold);
    }

    .type-btn i {
      font-size: 14px;
    }

    /* === Main Content === */
    .dashboard {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .map-container {
      position: relative;
      width: 100%;
      height: 300px;
      order: 1;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      border: 2px solid var(--accent-gold);
      overflow: hidden;
      z-index: 1;
    }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .map-control {
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 6px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--accent-gold);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .map-control:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    /* === Stats Panel === */
    .stats-panel {
      padding: 15px;
      order: 2;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-gold);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .stat-card {
      padding: 12px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      margin: 5px 0;
    }

    .stat-label {
      font-size: 11px;
      color: var(--light-gold);
      opacity: 0.9;
    }

    .active-filter {
      display: inline-block;
      padding: 3px 8px;
      background: var(--accent-gold);
      color: var(--primary-blue);
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    /* === Reports Table === */
    .reports-section {
      padding: 15px;
      order: 3;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }

    #tableFilterInfo {
      font-size: 12px;
      color: var(--light-gold);
      margin-left: 8px;
    }

    .refresh-btn {
      padding: 8px 15px;
      background: var(--accent-gold);
      color: var(--primary-blue);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      white-space: nowrap;
    }

    .refresh-btn:hover {
      background: #ffed4e;
      transform: translateY(-2px);
    }

    .refresh-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      margin-top: 10px;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      text-align: left;
      font-weight: 700;
      color: var(--accent-gold);
      border-bottom: 2px solid var(--glass-border);
      font-size: 12px;
      white-space: nowrap;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 12px;
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }

    .status-pending {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
    }

    .status-investigating {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .status-assigned {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
    }

    .status-resolved {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }

    .photo-btn {
      background: var(--accent-gold);
      color: var(--primary-blue);
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .photo-btn:hover {
      background: #ffed4e;
      transform: translateY(-2px);
    }

    /* === Photo Modal === */
    .photo-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .modal-content {
      width: 100%;
      max-width: 500px;
      max-height: 90%;
      background: var(--primary-blue);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      border: 2px solid var(--accent-gold);
    }

    .modal-img {
      width: 100%;
      height: auto;
      max-height: 60vh;
      object-fit: contain;
    }

    .modal-header {
      padding: 12px;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--accent-gold);
    }

    .modal-title {
      font-size: 16px;
      font-weight: bold;
      color: var(--accent-gold);
    }

    .modal-close {
      background: var(--danger-red);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .modal-close:hover {
      background: #ff6b6b;
    }

    /* === Loading States === */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
      font-size: 14px;
      color: var(--light-gold);
      flex-direction: column;
      text-align: center;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent-gold);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === Toast Notification === */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 15px;
      border-radius: 8px;
      border-left: 4px solid var(--accent-gold);
      z-index: 10000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fadeIn 0.3s ease-out;
    }

    /* === Connection Status === */
    .connection-status {
      position: fixed;
      bottom: 15px;
      left: 15px;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 5px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .connection-connected {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .connection-disconnected {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    /* === Animations === */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .glass, #map, .stat-card, tr {
      animation: fadeIn 0.5s ease-out;
    }

    /* === New Report Animation === */
    .new-report {
      animation: highlightNew 1s ease-out;
    }

    @keyframes highlightNew {
      0% { background-color: rgba(255, 215, 0, 0.3); }
      100% { background-color: transparent; }
    }

    /* === Desktop Layout === */
    @media (min-width: 768px) {
      .container {
        padding: 20px;
      }

      header {
        padding: 15px 20px;
        margin-bottom: 20px;
      }

      .logo-icon {
        font-size: 32px;
      }

      .title {
        font-size: 28px;
      }

      .subtitle {
        font-size: 12px;
      }

      .logout-btn {
        padding: 8px 16px;
        font-size: 14px;
      }

      .notification-btn {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }

      .type-filters {
        gap: 10px;
        margin-bottom: 20px;
      }

      .type-btn {
        padding: 10px 16px;
        font-size: 14px;
        flex: none;
      }

      .dashboard {
        flex-direction: row;
        gap: 20px;
      }

      .map-container {
        height: 500px;
        flex: 1;
        order: 1;
      }

      .stats-panel {
        width: 300px;
        order: 2;
        flex-shrink: 0;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .reports-section {
        order: 3;
        padding: 20px;
      }

      .section-title {
        font-size: 20px;
      }

      .refresh-btn {
        padding: 10px 18px;
        font-size: 14px;
      }

      th, td {
        padding: 12px;
        font-size: 13px;
      }

      .status-badge {
        font-size: 11px;
        padding: 5px 10px;
      }

      .photo-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .toast {
        left: auto;
        right: 30px;
        max-width: 350px;
      }
    }

    @media (min-width: 1024px) {
      .title {
        font-size: 32px;
      }

      .subtitle {
        font-size: 14px;
      }

      .type-btn {
        padding: 12px 20px;
        font-size: 15px;
      }

      .dashboard {
        gap: 25px;
      }

      .stats-panel {
        width: 320px;
      }
    }

    /* === Very Small Screens === */
    @media (max-width: 360px) {
      .container {
        padding: 10px;
      }

      header {
        padding: 10px;
      }

      .logo-icon {
        font-size: 24px;
      }

      .title {
        font-size: 18px;
      }

      .logout-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .notification-btn {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }

      .type-btn {
        font-size: 11px;
        padding: 6px 8px;
      }

      .type-btn i {
        font-size: 12px;
      }

      .map-container {
        height: 250px;
      }

      .stat-value {
        font-size: 20px;
      }

      .stat-label {
        font-size: 10px;
      }

      .section-title {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
  <!-- Photo Modal -->
  <div id="photoModal" class="photo-modal">
    <div class="modal-content glass">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Incident Photo</div>
        <button class="modal-close" onclick="closePhotoModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <img id="modalImage" class="modal-img" src="" alt="Incident Photo">
      <div style="padding: 15px; text-align: center;">
        <button class="photo-btn" onclick="closePhotoModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Connection Status Indicator -->
  <div id="connectionStatus" class="connection-status" style="display: none;">
    <i class="fas fa-circle"></i>
    <span>Connected</span>
  </div>

  <div class="container">
    <!-- Header -->
    <header class="glass">
      <div class="logo-area">
        <div class="logo-icon">
          <i class="fas fa-ambulance"></i>
        </div>
        <div class="logo-text">
          <div class="title">Ambulance<span>Station</span>
            <span class="realtime-indicator">
              <i class="fas fa-broadcast-tower"></i> LIVE
            </span>
          </div>
          <div class="subtitle">Ambulance Department Emergency Response Dashboard</div>
        </div>
      </div>

      <div class="controls-bar">
        <button class="logout-btn" onclick="logout()" title="Logout">
          <i class="fas fa-sign-out-alt"></i>
          <span class="logout-text">Logout</span>
        </button>
        <div class="notification-btn" onclick="window.location.href='#'" title="Notifications">
          <i class="fas fa-bell"></i>
          <span class="notif-dot" id="notifDot"></span>
        </div>
      </div>
    </header>

    <!-- Type Filter Buttons -->
    <div class="type-filters">
      <button class="type-btn active" onclick="filterByType('all', this)">
        <i class="fas fa-layer-group"></i> All Ambulance Cases
      </button>
      <button class="type-btn" onclick="filterByType('motor_accident', this)">
        <i class="fas fa-car-crash"></i> Vehicular Accidents
      </button>
      <button class="type-btn" onclick="filterByType('medical_emergency', this)">
        <i class="fas fa-ambulance"></i> Medical Emergencies
      </button>
      <button class="type-btn" onclick="filterByType('fire_accident', this)">
        <i class="fas fa-fire"></i> Fire Accidents
      </button>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <!-- Map Container -->
      <div class="map-container glass">
        <div class="map-overlay">
          <div class="map-control" onclick="fitAllMarkers()">
            <i class="fas fa-expand"></i> Show All
          </div>
          <div class="map-control" onclick="clearFilters()">
            <i class="fas fa-times"></i> Clear Filters
          </div>
        </div>
        <div id="map"></div>
      </div>

      <!-- Stats Panel -->
      <div class="stats-panel glass">
        <div class="panel-title">
          <i class="fas fa-chart-bar"></i> Ambulance Incident Overview
          <span id="filterBadge" class="active-filter" style="display: none;">Filtered</span>
        </div>

        <div class="stats-grid">
          <div class="stat-card glass">
            <div class="stat-value" id="totalIncidents">0</div>
            <div class="stat-label">Total Cases</div>
          </div>

          <div class="stat-card glass">
            <div class="stat-value" id="pendingIncidents">0</div>
            <div class="stat-label">Pending</div>
          </div>

          <div class="stat-card glass">
            <div class="stat-value" id="assignedIncidents">0</div>
            <div class="stat-label">Assigned</div>
          </div>

          <div class="stat-card glass">
            <div class="stat-value" id="resolvedIncidents">0</div>
            <div class="stat-label">Resolved</div>
          </div>
        </div>

        <div class="panel-title" style="margin-top: 10px;">
          <i class="fas fa-exclamation-triangle"></i> Case Types
        </div>

        <div class="stats-grid">
          <div class="stat-card glass">
            <div class="stat-value" id="motorAccidents">0</div>
            <div class="stat-label">Vehicular Accidents</div>
          </div>

          <div class="stat-card glass">
            <div class="stat-value" id="medicalEmergencies">0</div>
            <div class="stat-label">Medical Emergencies</div>
          </div>

          <div class="stat-card glass">
            <div class="stat-value" id="fireAccidents">0</div>
            <div class="stat-label">Fire Accidents</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Table -->
    <div class="reports-section glass">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-list-alt"></i> Active Ambulance Cases
          <span id="tableFilterInfo"></span>
        </div>
        <button class="refresh-btn" onclick="manualRefresh()" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>

      <div class="table-container">
        <table id="reportsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Location</th>
              <th>Status</th>
              <th>Time</th>
              <th>Photo</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody">
            <tr>
              <td colspan="6" class="loading">
                <div class="loading-spinner"></div>
                <span>Loading ambulance cases...</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ============ CONFIGURATION ============
    const SUPABASE_URL = 'https://gwvepxupoxyyydnisulb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3dmVweHVwb3h5eXlkbmlzdWxiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDE4ODcsImV4cCI6MjA4MDM3Nzg4N30.Ku9SXTAKNMvHilgEpxj5HcVA-0TPt4ziuEq0Irao5Qc';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const OPENCAGE_API_KEY = '0a78fbd8bcd74be398f210b34682c77c';

    // Map Initialization
    const map = L.map("map").setView([12.4048, 121.9829], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Incident Type Configuration (AMBULANCE RELATED ONLY)
    const typeConfig = {
      motor_accident: {
        name: 'Vehicular Accident',
        icon: 'car-crash',
        color: '#e74c3c'
      },
      fire_accident: {
        name: 'Fire Accident',
        icon: 'fire',
        color: '#f39c12'
      },
      medical_emergency: {
        name: 'Medical Emergency',
        icon: 'ambulance',
        color: '#e91e63'
      }
    };

    // ============ GLOBAL VARIABLES ============
    let markers = [];
    let allReports = [];
    let filteredReports = [];
    let currentFilter = 'all';
    let realtimeSubscription = null;
    let addressCache = new Map();
    let isInitialLoad = true;

    // ============ AUTHENTICATION & LOGOUT ============
    function checkAuthentication() {
      const user = localStorage.getItem('user');
      if (!user) {
        window.location.href = 'index.html';
        return false;
      }

      try {
        const userData = JSON.parse(user);
        
        // Allow ambulance station access if user is admin or has ambulance station
        if (userData.station === 'ambulance' || userData.email === 'medicaladmin@gmail.com') {
          return true;
        }
        
        // Also allow if user has any admin role
        if (userData.role === 'admin') {
          return true;
        }
        
        alert('Access denied. You do not have permission to access the Ambulance Dashboard.');
        window.location.href = 'index.html';
        return false;
        
      } catch (error) {
        console.error('Error parsing user data:', error);
        window.location.href = 'index.html';
        return false;
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('user');
        supabaseClient.auth.signOut().finally(() => {
          window.location.href = 'index.html';
        });
      }
    }

    // ============ CONNECTION STATUS ============
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (connected) {
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Realtime Connected';
        statusEl.className = 'connection-status connection-connected';
        statusEl.style.display = 'flex';

        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      } else {
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Connection Lost';
        statusEl.className = 'connection-status connection-disconnected';
        statusEl.style.display = 'flex';
      }
    }

    // ============ OPENCAGE GEOCODING ============
    async function getReadableAddress(lat, lng) {
      try {
        const cacheKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        if (addressCache.has(cacheKey)) {
          return addressCache.get(cacheKey);
        }

        const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${OPENCAGE_API_KEY}&language=en&limit=1`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.results && data.results.length > 0) {
          const address = data.results[0].formatted;
          addressCache.set(cacheKey, address);
          return address;
        }
        return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      } catch (error) {
        console.error('Geocoding error:', error);
        return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      }
    }

    // ============ PHOTO HANDLING ============
    function showPhotoModal(imageUrl, title = 'Incident Photo') {
      const modal = document.getElementById('photoModal');
      const modalImg = document.getElementById('modalImage');
      const modalTitle = document.getElementById('modalTitle');

      if (imageUrl && imageUrl !== 'null' && imageUrl !== 'undefined') {
        modalImg.src = imageUrl;
        modalTitle.textContent = title;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      } else {
        showToast('No photo available for this incident', 'warning');
      }
    }

    function closePhotoModal() {
      const modal = document.getElementById('photoModal');
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function getPhotoUrl(report) {
      if (report.photo_url && report.photo_url.trim() && report.photo_url.trim() !== 'null') {
        return report.photo_url.trim();
      }

      if (report.photo && report.photo.trim() && report.photo.trim() !== 'null') {
        if (report.photo.startsWith('data:image')) {
          return report.photo;
        }

        if (report.photo.startsWith('incident_photos/')) {
          const { data } = supabaseClient.storage
            .from('incident_photos')
            .getPublicUrl(report.photo);

          if (data && data.publicUrl) {
            return data.publicUrl;
          }
        }

        return report.photo;
      }

      if (report.image_url && report.image_url.trim() && report.image_url.trim() !== 'null') {
        return report.image_url.trim();
      }

      return null;
    }

    // ============ MAP MARKERS ============
    function createCustomIcon(type) {
      const config = typeConfig[type] || { 
        name: 'Unknown', 
        icon: 'exclamation-triangle', 
        color: '#3498db' 
      };
      return L.divIcon({
        html: `
          <div style="
            background-color: ${config.color};
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
          ">
            <i class="fas fa-${config.icon}"></i>
          </div>
        `,
        className: 'custom-marker',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });
    }

    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }

    function addReportMarker(report, isNew = false) {
      if (!report.latitude || !report.longitude) return null;

      const icon = createCustomIcon(report.type);
      const marker = L.marker([report.latitude, report.longitude], { icon }).addTo(map);

      if (isNew) {
        marker._icon.style.animation = 'pulse 1s 3';
      }

      const status = report.status || 'pending';
      const photoUrl = getPhotoUrl(report);

      const popupContent = `
        <div style="
          font-family: 'Segoe UI', sans-serif;
          min-width: 280px;
          max-width: 320px;
          padding: 8px;
        ">
          <div style="
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid ${typeConfig[report.type]?.color || '#3498db'};
          ">
            <div style="
              background-color: ${typeConfig[report.type]?.color || '#3498db'};
              width: 16px;
              height: 16px;
              border-radius: 50%;
            "></div>
            <h3 style="margin: 0; color: #333; font-size: 14px; font-weight: bold;">
              ${typeConfig[report.type]?.name || 'Unknown Incident'}
            </h3>
          </div>

          <div style="margin-bottom: 10px;">
            <div style="color: #555; font-size: 10px; font-weight: 600; margin-bottom: 3px;">
              <i class="fas fa-map-marker-alt"></i> LOCATION
            </div>
            <div style="color: #222; font-size: 12px; line-height: 1.3;">
              ${report.location || 'Location not specified'}
            </div>
          </div>

          <div style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
          ">
            <div>
              <div style="color: #555; font-size: 10px; font-weight: 600; margin-bottom: 3px;">
                <i class="fas fa-user"></i> REPORTER
              </div>
              <div style="color: #222; font-size: 12px;">
                ${report.reporter_name || 'Anonymous'}
              </div>
            </div>

            <div>
              <div style="color: #555; font-size: 10px; font-weight: 600; margin-bottom: 3px;">
                <i class="fas fa-id-card"></i> REPORT ID
              </div>
              <div style="color: #222; font-size: 12px; font-weight: bold;">
                #${report.id}
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <div style="color: #555; font-size: 10px; font-weight: 600; margin-bottom: 4px;">
              <i class="fas fa-info-circle"></i> STATUS
            </div>
            <div style="
              display: inline-block;
              padding: 4px 10px;
              border-radius: 12px;
              font-size: 10px;
              font-weight: bold;
              background-color: ${getStatusColor(status).bg};
              color: ${getStatusColor(status).text};
            ">
              ${status.charAt(0).toUpperCase() + status.slice(1)}
            </div>
          </div>
          
          ${photoUrl ? `
            <div style="margin-bottom: 12px;">
              <div style="color: #555; font-size: 10px; font-weight: 600; margin-bottom: 4px;">
                <i class="fas fa-camera"></i> INCIDENT PHOTO
              </div>
              <div style="
                background: #f5f5f5;
                border-radius: 6px;
                padding: 6px;
                text-align: center;
                cursor: pointer;
                border: 1px solid #ddd;
              " onclick="window.showPhotoModal('${photoUrl}', 'Report #${report.id}')">
                <img src="${photoUrl}" 
                  style="
                    max-width: 100%;
                    max-height: 100px;
                    border-radius: 4px;
                    margin-bottom: 6px;
                  "
                  onerror="this.onerror=null; this.src='https://via.placeholder.com/250x100/cccccc/666666?text=Photo+Not+Available';"
                >
                <div style="color: #666; font-size: 10px; margin-top: 3px;">
                  <i class="fas fa-search-plus"></i> Click to view
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      marker.bindPopup(popupContent);
      markers.push(marker);
      return marker;
    }

    function getStatusColor(status) {
      switch(status) {
        case 'pending': return { bg: '#fff3cd', text: '#856404' };
        case 'investigating': return { bg: '#d1ecf1', text: '#0c5460' };
        case 'assigned': return { bg: '#cce5ff', text: '#004085' };
        case 'resolved': return { bg: '#d4edda', text: '#155724' };
        default: return { bg: '#f8d7da', text: '#721c24' };
      }
    }

    // ============ DATA PROCESSING ============
    async function processReport(rawReport) {
      // Determine incident type - ONLY ambulance-related incidents
      let incidentType = '';
      const dbType = (rawReport.type || '').toString().toLowerCase().trim();
      
      // Map database types to ambulance-related categories
      if (dbType.includes('motor') || dbType.includes('accident') || dbType.includes('vehicular') || dbType === 'accident') {
        incidentType = 'motor_accident';
      } else if (dbType.includes('fire')) {
        incidentType = 'fire_accident';
      } else if (dbType.includes('medical') || dbType.includes('emergency') || dbType.includes('health')) {
        incidentType = 'medical_emergency';
      }
      
      // Skip if not an ambulance-related incident
      if (!incidentType) return null;
      
      // Get location
      const lat = parseFloat(rawReport.latitude);
      const lng = parseFloat(rawReport.longitude);
      let location = 'Location not specified';
      
      if (!isNaN(lat) && !isNaN(lng)) {
        try {
          location = await getReadableAddress(lat, lng);
        } catch (error) {
          location = `Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }
      } else if (rawReport.location_name && rawReport.location_name.trim()) {
        location = rawReport.location_name.trim();
      } else if (rawReport.location && rawReport.location.trim()) {
        location = rawReport.location.trim();
      }
      
      const reporterName = rawReport.reporter || rawReport.reporter_name || rawReport.name || rawReport.reporter_email || 'Anonymous';
      const photoUrl = getPhotoUrl(rawReport);
      
      return {
        id: rawReport.id,
        type: incidentType,
        location: location,
        reporter_name: reporterName,
        created_at: rawReport.created_at || rawReport.reported_at || new Date().toISOString(),
        status: (rawReport.status || 'pending').toLowerCase(),
        latitude: isNaN(lat) ? 12.4048 : lat,
        longitude: isNaN(lng) ? 121.9829 : lng,
        description: rawReport.description || rawReport.details || rawReport.incident_details || '',
        photo_url: photoUrl,
        photo: rawReport.photo || rawReport.photo_url || rawReport.image_url || null,
        original_data: rawReport
      };
    }

    // ============ REALTIME DATA HANDLING ============
    async function addNewReport(reportData) {
      const processedReport = await processReport(reportData);
      if (!processedReport) return; // Skip if not ambulance-related
      
      const existingIndex = allReports.findIndex(r => r.id === processedReport.id);
      if (existingIndex >= 0) {
        allReports[existingIndex] = processedReport;
      } else {
        allReports.unshift(processedReport);
        showToast(`New ${typeConfig[processedReport.type]?.name || 'incident'} reported`, 'info');
      }
      
      applyFilters();
      highlightNewReport(processedReport.id);
    }

    function updateExistingReport(reportData) {
      const index = allReports.findIndex(r => r.id === reportData.id);
      if (index >= 0) {
        processReport(reportData).then(updatedReport => {
          if (!updatedReport) {
            // If updated report is no longer ambulance-related, remove it
            allReports.splice(index, 1);
          } else {
            allReports[index] = updatedReport;
          }
          applyFilters();
        });
      }
    }

    function removeReport(reportId) {
      const index = allReports.findIndex(r => r.id === reportId);
      if (index >= 0) {
        allReports.splice(index, 1);
        applyFilters();
      }
    }

    function highlightNewReport(reportId) {
      const tableRow = document.querySelector(`tr[data-report-id="${reportId}"]`);
      if (tableRow) {
        tableRow.classList.add('new-report');
        setTimeout(() => {
          tableRow.classList.remove('new-report');
        }, 1000);
      }
    }

    // ============ REALTIME SUBSCRIPTION ============
    function setupRealtimeSubscription() {
      if (realtimeSubscription) {
        supabaseClient.removeChannel(realtimeSubscription);
      }

      realtimeSubscription = supabaseClient
        .channel('reports-realtime')
        .on('postgres_changes', 
          { 
            event: '*', 
            schema: 'public', 
            table: 'reports' 
          }, 
          (payload) => {
            if (payload.eventType === 'INSERT') {
              addNewReport(payload.new);
            } else if (payload.eventType === 'UPDATE') {
              updateExistingReport(payload.new);
            } else if (payload.eventType === 'DELETE') {
              removeReport(payload.old.id);
            }
            
            updateConnectionStatus(true);
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            updateConnectionStatus(true);
          } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
            updateConnectionStatus(false);
            setTimeout(() => {
              if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
                setupRealtimeSubscription();
              }
            }, 5000);
          }
        });
    }

    // ============ INITIAL DATA LOAD ============
    async function loadInitialData() {
      const tableBody = document.getElementById('reportsTableBody');
      const refreshBtn = document.getElementById('refreshBtn');

      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="loading">
            <div class="loading-spinner"></div>
            <span>Loading ambulance cases...</span>
          </td>
        </tr>
      `;

      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
      refreshBtn.disabled = true;

      try {
        const { data, error } = await supabaseClient
          .from('reports')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        // Process all reports and filter for ambulance-related ones
        const reportPromises = (data || []).map(processReport);
        const processedReports = await Promise.all(reportPromises);
        
        // Filter out null reports (non-ambulance incidents)
        allReports = processedReports.filter(report => report !== null);

        if (allReports.length > 0) {
          setupRealtimeSubscription();
          applyFilters();
          updateStatistics();
          showToast(`Loaded ${allReports.length} ambulance cases`, 'success');
        } else {
          showToast('No ambulance cases found in database', 'info');
        }

      } catch (error) {
        console.error('Error loading reports:', error);
        showToast(`Error loading ambulance cases: ${error.message}`, 'error');

      } finally {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        refreshBtn.disabled = false;
        isInitialLoad = false;
      }
    }

    // ============ FILTERS ============
    function applyFilters() {
      clearMarkers();
      
      filteredReports = allReports.filter(report => {
        if (currentFilter !== 'all' && report.type !== currentFilter) {
          return false;
        }
        return true;
      });
      
      filteredReports.forEach(report => {
        addReportMarker(report);
      });
      
      updateTable();
      updateStatistics();
      updateFilterIndicators();
      
      if (!isInitialLoad && filteredReports.length > 0) {
        const validMarkers = markers.filter(marker => marker.getLatLng());
        if (validMarkers.length > 0) {
          const group = new L.featureGroup(validMarkers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      }
    }

    function filterByType(type, buttonElement) {
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
      if (buttonElement) buttonElement.classList.add('active');
      currentFilter = type;
      applyFilters();
    }

    function clearFilters() {
      currentFilter = 'all';
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('.type-btn[onclick*="filterByType(\'all\'"]').classList.add('active');
      applyFilters();
    }

    function fitAllMarkers() {
      const validMarkers = markers.filter(marker => marker.getLatLng());
      if (validMarkers.length > 0) {
        const group = new L.featureGroup(validMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
        showToast('Zoomed to show all incidents', 'info');
      } else {
        showToast('No incidents to display', 'warning');
      }
    }

    // ============ UI UPDATES ============
    function updateStatistics() {
      const total = allReports.length;
      const pending = allReports.filter(r => r.status === 'pending').length;
      const assigned = allReports.filter(r => r.status === 'assigned' || r.status === 'investigating').length;
      const resolved = allReports.filter(r => r.status === 'resolved').length;

      const motorAccidents = allReports.filter(r => r.type === 'motor_accident').length;
      const medicalEmergencies = allReports.filter(r => r.type === 'medical_emergency').length;
      const fireAccidents = allReports.filter(r => r.type === 'fire_accident').length;

      document.getElementById('totalIncidents').textContent = total;
      document.getElementById('pendingIncidents').textContent = pending;
      document.getElementById('assignedIncidents').textContent = assigned;
      document.getElementById('resolvedIncidents').textContent = resolved;

      document.getElementById('motorAccidents').textContent = motorAccidents;
      document.getElementById('medicalEmergencies').textContent = medicalEmergencies;
      document.getElementById('fireAccidents').textContent = fireAccidents;
      
      const notifDot = document.getElementById('notifDot');
      if (pending > 0) {
        notifDot.style.display = 'block';
      } else {
        notifDot.style.display = 'none';
      }
    }

    function updateTable() {
      const tableBody = document.getElementById('reportsTableBody');
      
      if (filteredReports.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 30px; color: var(--light-gold);">
              <i class="fas fa-search" style="font-size: 28px; margin-bottom: 10px; opacity: 0.5;"></i>
              <br>
              ${allReports.length === 0 ? 
                'No ambulance cases in database yet.' : 
                'No cases match the current filters.'}
              <br>
              <small style="opacity: 0.7; margin-top: 8px; display: block;">
                ${allReports.length === 0 ? 
                  'Emergency reports will appear here when submitted.' : 
                  'Try clearing filters or selecting a different incident type.'}
              </small>
            </td>
          </tr>
        `;
        return;
      }
      
      const sortedReports = [...filteredReports].sort((a, b) => 
        new Date(b.created_at) - new Date(a.created_at)
      );
      
      tableBody.innerHTML = sortedReports.map(report => {
        const photoUrl = getPhotoUrl(report);
        const statusClass = report.status === 'pending' ? 'status-pending' : 
                           report.status === 'investigating' ? 'status-investigating' : 
                           report.status === 'assigned' ? 'status-assigned' :
                           'status-resolved';
        
        const shortLocation = report.location.length > 30 ? 
          report.location.substring(0, 30) + '...' : report.location;
        
        return `
          <tr data-report-id="${report.id}">
            <td><strong>#${report.id}</strong></td>
            <td>
              <div style="display: flex; align-items: center; gap: 6px;">
                <div style="
                  width: 10px;
                  height: 10px;
                  border-radius: 50%;
                  background-color: ${typeConfig[report.type]?.color || '#3498db'};
                "></div>
                ${typeConfig[report.type]?.name || 'Unknown'}
              </div>
            </td>
            <td title="${report.location}">
              ${shortLocation}
            </td>
            <td>
              <span class="status-badge ${statusClass}">
                ${report.status ? report.status.charAt(0).toUpperCase() + report.status.slice(1) : 'Pending'}
              </span>
            </td>
            <td>
              ${new Date(report.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
              <div style="font-size: 9px; color: #ccc;">
                ${new Date(report.created_at).toLocaleDateString()}
              </div>
            </td>
            <td>
              ${photoUrl ? `
                <button class="photo-btn" onclick="showPhotoModal('${photoUrl}', 'Report #${report.id}')">
                  <i class="fas fa-camera"></i> View
                </button>
              ` : `
                <span style="color: #95a5a6; font-size: 11px;">-</span>
              `}
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateFilterIndicators() {
      const filterBadge = document.getElementById('filterBadge');
      const tableFilterInfo = document.getElementById('tableFilterInfo');
      
      if (currentFilter === 'all') {
        filterBadge.style.display = 'none';
        tableFilterInfo.textContent = '';
      } else {
        filterBadge.style.display = 'inline-block';
        filterBadge.textContent = typeConfig[currentFilter]?.name || currentFilter;
        tableFilterInfo.textContent = ` (Filtered: ${typeConfig[currentFilter]?.name || currentFilter})`;
      }
    }

    function showToast(message, type = 'info') {
      const colors = {
        info: 'var(--accent-gold)',
        success: 'var(--success-green)',
        error: 'var(--danger-red)',
        warning: 'var(--warning-orange)'
      };
      
      const icons = {
        info: 'info-circle',
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle'
      };
      
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <i class="fas fa-${icons[type]}" style="color: ${colors[type]}; font-size: 16px;"></i>
        <span style="font-size: 13px;">${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(10px)';
          setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
          }, 300);
        }
      }, 3000);
    }

    // ============ MANUAL REFRESH ============
    async function manualRefresh() {
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
      refreshBtn.disabled = true;

      try {
        const { data, error } = await supabaseClient
          .from('reports')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        const reportPromises = (data || []).map(processReport);
        const processedReports = await Promise.all(reportPromises);
        
        allReports = processedReports.filter(report => report !== null);
        
        applyFilters();
        showToast(`Refreshed ${allReports.length} cases`, 'success');

      } catch (error) {
        console.error('Refresh error:', error);
        showToast('Refresh failed: ' + error.message, 'error');

      } finally {
        setTimeout(() => {
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
          refreshBtn.disabled = false;
        }, 1000);
      }
    }

    // ============ INITIALIZATION ============
    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuthentication()) return;

      console.log(' Ambulance Department Dashboard Initializing...');

      // Load initial data
      loadInitialData();

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          manualRefresh();
        }
        if (e.key === 'Escape') {
          const modal = document.getElementById('photoModal');
          if (modal.style.display === 'flex') {
            closePhotoModal();
          } else {
            clearFilters();
          }
        }
      });

      // Handle page visibility changes
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && !realtimeSubscription) {
          setupRealtimeSubscription();
        }
      });

      // Make functions globally available
      window.showPhotoModal = showPhotoModal;
      window.closePhotoModal = closePhotoModal;
      window.filterByType = filterByType;
      window.clearFilters = clearFilters;
      window.fitAllMarkers = fitAllMarkers;
      window.manualRefresh = manualRefresh;
      window.logout = logout;
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (realtimeSubscription) {
        supabaseClient.removeChannel(realtimeSubscription);
      }
    });
  </script>
</body>
</html>